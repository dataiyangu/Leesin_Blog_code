
title: åŸºäºNettyçš„RPCæ¶æ„å­¦ä¹ ç¬”è®°ï¼ˆå…«ï¼‰ï¼šprotocol buffå­¦ä¹ ä½¿ç”¨
author: Leesin.Dong
top: 
tags:
  - Netty
categories:
  - å­¦ä¹ ç¬”è®°
  - åŸºäºNettyçš„RPCæ¶æ„å­¦ä¹ ç¬”è®°
date: 2019-3-10 10:21:08

---

# ç®€ä»‹
protocol buffæ˜¯ä¸€ç§åè®®ï¼Œæ˜¯è°·æ­Œæ¨å‡ºçš„ä¸€ç§åºåˆ—åŒ–åè®®
Javaåºåˆ—åŒ–åè®®ä¹Ÿæ˜¯ä¸€ç§åè®®
ä¸¤è€…çš„ç›®çš„æ˜¯ï¼Œå°†å¯¹è±¡åºåˆ—åŒ–æˆå­—èŠ‚æ•°ç»„ï¼Œæˆ–è€…è¯´æ˜¯äºŒè¿›åˆ¶æ•°æ®
# å‡†å¤‡
protobufçš„ä¸¤ä¸ªjaråŒ…ã€ protoc.exe(ç”Ÿæˆjavaçš„æºä»£ç ï¼Œéœ€è¦å†™protobufçš„é…ç½®æ–‡ä»¶æ‰èƒ½ç”Ÿæˆã€‚)
## protobufé…ç½®æ–‡ä»¶
ä»»æ„ç›®å½•æ–°å»ºæ–‡ä»¶å¤¹ï¼ˆä»»æ„åå­—ï¼‰==ã€‹æ–°å»ºprotoæ–‡ä»¶ï¼ˆä»»æ„åå­—ï¼Œä¾‹å¦‚player.protoï¼‰åç¼€ä¸ºproto

```js
//åŒ…å
option java_package = "com.proto";
//java_outer_classnameçš„ä½œç”¨æ˜¯å°†Palerç±»å’ŒResourceç±»æ•´åˆåˆ°ä¸€ä¸ªå¤§çš„ç±»ä¸­ï¼Œä¸€ä¸ªå¤§çš„Moudleä¸­ï¼Œåå«PlayerModule
option java_outer_classname = "PlayerModule";
//messageç›¸å½“äºjavaä¸­çš„class
message PBPlayer{
//åœ¨protobufä¸­æ²¡æœ‰intå’Œlongå½“æ—¶æœ‰å¯¹åº”çš„ç±»å‹ï¼Œint32æ˜¯intç±»å‹ï¼Œint64æ˜¯longç±»å‹
//requiredæ„æ€æ˜¯è¿™ä¸ªå­—æ®µç±»å‹å¿…é¡»è®¾ç½®ï¼ŒåŠ å…¥ä¸è®¾ç½®å°±ä¼šæŠ¥é”™
//åé¢çš„123æ˜¯keyå€¼ï¼Œè¿™äº›keyå€¼åœ¨messageä¸­æ˜¯ä¸èƒ½é‡å¤çš„ï¼Œè¿™é‡Œçš„keyç›¸å½“äº{nameï¼šxiaoming}ä¸­çš„name
	required int64 playerId = 1;
	
	required int32 age = 2;
	
	required string name = 3;
	//repeatedçš„æ„æ€æ˜¯listï¼Œé‡å¤intçš„list
	repeated int32 skills = 4;
}

message PBResource{
//é‡‘å¸
	required int64 gold = 1;
	
	required int32 energy = 2;
}
```
## ç”Ÿæˆjavaä»£ç 
å°†ä¸Šé¢çš„player.protoæ”¾åˆ°protoc.exeçš„åŒçº§ç›®å½•===ã€‹åœ¨è¿™ä¸ªç›®å½•ä¸­æ–°å»ºbuild.bat
build.bat

```js
//å¦‚æœæ˜¯ç”Ÿæˆcä»£ç å°±æ˜¯--cpp_out
//=åé¢æ˜¯å°†javaæ–‡ä»¶ç”Ÿæˆåˆ°å“ªä¸ªç›®å½•
protoc ./player.protp --java_out=./
//æ–­ç‚¹å¯åŠ¨æ–¹ä¾¿è§‚å¯Ÿé”™è¯¯
pasue
```
ç‚¹å‡»build.batä¼šè‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªæ–‡ä»¶åŠ com.proto ===ã€‹PlayerModule.java

# ä¸¾ä¸ªğŸŒ°
æ–°å»ºé¡¹ç›®==ã€‹libsç”¨æ¥æ”¾jaråŒ…==ã€‹æ–°å»ºprotoç›®å½•ç”¨æ¥æ”¾protoæ–‡ä»¶==ã€‹æŠŠä¸Šé¢çš„ä¸¤ä¸ªjaræ‹·è´è¿‡å» ==ã€‹protoæ–‡ä»¶æ‹·è´åˆ°protoç›®å½•ä¸­==ã€‹protoc.exeå’Œbuild.batæ‹·è´åˆ°é¡¹ç›®æ ¹ç›®å½•
ä¿®æ”¹build.bat
```js
protoc ./proto/*.protp --java_out=./src
pasue
```
åœ¨srcä¸‹æ–°å»ºPB2Bytes.java

```js
package com.java;

import java.io.ByteArrayInputStream;
import java.io.ByteArrayOutputStream;
import java.io.IOException;
import java.io.ObjectInputStream;
import java.io.ObjectOutputStream;
import java.util.Arrays;

public class JAVA2Bytes {

	public static void main(String[] args) throws Exception {
		byte[] bytes = toBytes();
		toPlayer(bytes);
	}
	
	
	/**
	 * åºåˆ—åŒ–
	 * @throws IOException 
	 */
	public static byte[] toBytes() throws IOException{
		
		Player player = new Player(101, 20, "peter");
		player.getSkills().add(1001);
		
		ByteArrayOutputStream byteArrayOutputStream = new ByteArrayOutputStream();
		ObjectOutputStream objectOutputStream = new ObjectOutputStream(byteArrayOutputStream);
		
		//å†™å…¥å¯¹è±¡
		objectOutputStream.writeObject(player);
		
		//è·å– å­—èŠ‚æ•°ç»„
		byte[] byteArray = byteArrayOutputStream.toByteArray();
		System.out.println(Arrays.toString(byteArray));
		return byteArray;
	}
	
	
	/**
	 * ååºåˆ—åŒ–
	 * @param bs
	 * @throws Exceptipackage com.proto;

import java.util.Arrays;
import com.proto.PlayerModule.PBPlayer;
import com.proto.PlayerModule.PBPlayer.Builder;
/**

- protobufå­¦ä¹ 

- @author 
   */
  public class PB2Bytes {

  public static void main(String[] args) throws Exception {
  	byte[] bytes = toBytes();
  	toPlayer(bytes);

  }

  /**

  - åºåˆ—åŒ–
    */
    public static byte[] toBytes(){
    //è·å–ä¸€ä¸ªPBPlayerçš„æ„é€ å™¨
    Builder builder = PlayerModule.PBPlayer.newBuilder();
    //è®¾ç½®æ•°æ®
    //ä¸Šé¢skillæ˜¯listï¼Œæœ¬åº”è¯¥setSkillï¼Œå¯æ˜¯è¿™é‡Œæ˜¯setSkillï¼ˆindexï¼Œvalueï¼‰ï¼Œä¸æ˜¯æˆ‘ä»¬å¹³å¸¸çš„skill
    //å¯ä»¥ç›´æ¥addSkillï¼ˆ1001ï¼‰æ·»åŠ 1001è¿™ä¸ªæŠ€èƒ½
    //å‰é¢æ–‡ä»¶æ–‡åŠ äº†requiredå‰ç¼€çš„å¿…é¡»è¦åœ¨è¿™é‡Œè®¾ç½®å€¼ï¼Œä¸ç„¶ä¼šæŠ¥é”™å¦‚ä¸‹
    //Message missing required field
    builder.setPlayerId(101).setAge(20).setName("peter").addSkills(1001);
    //æ„é€ å‡ºå¯¹è±¡
    PBPlayer player = builder.build();
    //åºåˆ—åŒ–æˆå­—èŠ‚æ•°ç»„
    byte[] byteArray = player.toByteArray();

    System.out.println(Arrays.toString(byteArray));

    return byteArray;
    }

  /**

  - ååºåˆ—åŒ–

  - @param bs

  - @throws Exception 
    */
    public static void toPlayer(byte[] bs) throws Exception{

     PBPlayer player = PlayerModule.PBPlayer.parseFrom(bs);

     System.out.println("playerId:" + player.getPlayerId());
     System.out.println("age:" + player.getAge());
     System.out.println("name:" + player.getName());
     System.out.println("skills:" + (Arrays.toString(player.getSkillsList().toArray())));
    }
    }
```
è¾“å‡º

```js
[8,101,16,20,16,5,112,101,116,101,114,32,-23,7]
101
20
peter
1001
```
# javaåºåˆ—åŒ–å’Œååºåˆ—åŒ–
Player.java

```js
package com.java;

import java.io.Serializable;
import java.util.ArrayList;
import java.util.List;

/**

- ç©å®¶å¯¹è±¡

- 
- 
  *
   */
  public class Player implements Serializable{

  /**

  - */
    private static final long serialVersionUID = -5248069984631225347L;

  public Player(long playerId,  int age, String name) {
  	this.playerId = playerId;
  	this.age = age;
  	this.name = name;
  }

  private long playerId;

  private int age;

  private String name;

  private List<Integer> skills = new ArrayList<>();

  public long getPlayerId() {
  	return playerId;
  }

  public void setPlayerId(long playerId) {
  	this.playerId = playerId;
  }

  public int getAge() {
  	return age;
  }

  public void setAge(int age) {
  	this.age = age;
  }

  public String getName() {
  	return name;
  }

  public void setName(String name) {
  	this.name = name;
  }

  public List<Integer> getSkills() {
  	return skills;
  }

  public void setSkills(List<Integer> skills) {
  	this.skills = skills;
  }
  }
```
JAVA2Bytes.java

```js
package com.java;

import java.io.ByteArrayInputStream;
import java.io.ByteArrayOutputStream;
import java.io.IOException;
import java.io.ObjectInputStream;
import java.io.ObjectOutputStream;
import java.util.Arrays;

public class JAVA2Bytes {

	public static void main(String[] args) throws Exception {
		byte[] bytes = toBytes();
		toPlayer(bytes);
	}
	
	
	/**
	 * åºåˆ—åŒ–
	 * @throws IOException 
	 */
	public static byte[] toBytes() throws IOException{
		
		Player player = new Player(101, 20, "peter");
		player.getSkills().add(1001);
		
		ByteArrayOutputStream byteArrayOutputStream = new ByteArrayOutputStream();
		ObjectOutputStream objectOutputStream = new ObjectOutputStream(byteArrayOutputStream);
		
		//å†™å…¥å¯¹è±¡
		objectOutputStream.writeObject(player);
		
		//è·å– å­—èŠ‚æ•°ç»„
		//ObjectOutputStream objectOutputStream = new ObjectOutputStream(byteArrayOutputStream);
		//æœ€ç»ˆæ˜¯å†™åˆ°byteArrayOutputStreamä¸­ï¼Œæ‰€ä»¥é€šè¿‡byteArrayOutputStreamè·å¾—ã€‚
		byte[] byteArray = byteArrayOutputStream.toByteArray();
		System.out.println(Arrays.toString(byteArray));
		return byteArray;
	}
	
	
	/**
	 * ååºåˆ—åŒ–
	 * @param bs
	 * @throws Exception 
	 */
	public static void toPlayer(byte[] bs) throws Exception{
		
		ObjectInputStream inputStream = new ObjectInputStream(new ByteArrayInputStream(bs));
		Player player = (Player)inputStream.readObject();
		
		//æ‰“å°
		 System.out.println("playerId:" + player.getPlayerId());
		 System.out.println("age:" + player.getAge());
		 System.out.println("name:" + player.getName());
		 System.out.println("skills:" + (Arrays.toString(player.getSkills().toArray())));
	}

}

```
è¾“å‡º
```js
[-84,-19,0,5,115,114,0,15,99,111,109,46,106,97,118,97,46,80,108........]
101
20
peter
1001
```
# ä¸åŒ
javaåºåˆ—åŒ–å‡ºæ¥çš„å­—èŠ‚æ•°ç»„æ¯”proto buffçš„é•¿å¾ˆå¤šï¼Œå­—èŠ‚æ•°ç»„çŸ­çš„è¯èƒ½å¤Ÿå‡å°‘å¾ˆå¤šçš„å¸¦å®½ã€‚

ä¸ºä»€ä¹ˆï¼Ÿ

javaä¸­çš„å­—èŠ‚æ•°ç»„åŒ…æ‹¬è¿™ä¸ªç±»çš„ç±»ä¿¡æ¯ã€è¿™ä¸ªç±»æœ‰å“ªä¸ªå­—æ®µã€åè®®å¤´ã€æ¯ä¸ªç±»å«ä»€ä¹ˆåç§°ã€æ¯ä¸ªç±»æ˜¯ä»€ä¹ˆç±»å‹çš„ã€æœ€åçš„æ•°å€¼æ˜¯å¤šå°‘ç­‰ã€‚

proto buffä¸è®¸è¦æœ‰é…ç½®æ–‡ä»¶ï¼Œjavaä¸éœ€è¦åªè¦åŒæ–¹éƒ½æ˜¯javaå°±è¡Œï¼Œæ‰€ä»¥proto buffå…¶å®æ˜¯æŠŠç±»çš„åç§°ã€ç±»å‹ã€å­—æ®µç­‰éƒ½å†™åˆ°äº†é…ç½®æ–‡ä»¶ä¸­ï¼Œæ‰€ä»¥åœ¨åºåˆ—åŒ–çš„æ—¶å€™é›†æˆäº†è¿™äº›æè¿°ä¿¡æ¯ï¼Œæ‰€ä»¥å­—èŠ‚å¾ˆçŸ­ã€‚

proto buffåˆ†é…ç©ºé—´æ˜¯æœ‰ä¼¸ç¼©æ€§çš„ï¼Œæ¯”å¦‚int åœ¨å†…å­˜ä¸­æ˜¯ 4 ä¸ªå­—èŠ‚ï¼Œproto buffæ ¹æ®å®é™…å¤§å°åˆ†é…1-5ä¸ªå­—èŠ‚ï¼Œä»æ¦‚ç‡å­¦çš„è§’åº¦è®²å¤§éƒ¨åˆ†å¯èƒ½éƒ½æ˜¯ä¸€ä¸ªæˆ–è€…ä¸¤ä¸ªå­—èŠ‚