title: åŸºäºNettyçš„RPCæ¶æ„å­¦ä¹ ç¬”è®°ï¼ˆä¸ƒï¼‰ï¼šnettyå­¦ä¹ ä¹‹å¿ƒè·³
author: Leesin.Dong
top: 
tags:

  - Netty
categories:
  - å­¦ä¹ ç¬”è®°
  - åŸºäºNettyçš„RPCæ¶æ„å­¦ä¹ ç¬”è®°
date: 2019-3-10 10:21:07

---


# idleStateHandler
Nettyæä¾›çš„æ£€æµ‹ä¼šè¯çŠ¶æ€çš„å·¥å…·ã€‚
## netty3ğŸŒ°
Server.java

```js
package com.heart;

import java.net.InetSocketAddress;
import java.util.concurrent.ExecutorService;
import java.util.concurrent.Executors;

import org.jboss.netty.bootstrap.ServerBootstrap;
import org.jboss.netty.channel.ChannelPipeline;
import org.jboss.netty.channel.ChannelPipelineFactory;
import org.jboss.netty.channel.Channels;
import org.jboss.netty.channel.socket.nio.NioServerSocketChannelFactory;
import org.jboss.netty.handler.codec.string.StringDecoder;
import org.jboss.netty.handler.codec.string.StringEncoder;
import org.jboss.netty.handler.timeout.IdleStateHandler;
import org.jboss.netty.util.HashedWheelTimer;
/**
 * 
 */
public class Server {

	public static void main(String[] args) {

		//æœåŠ¡ç±»
		ServerBootstrap bootstrap = new ServerBootstrap();
		
		//bossçº¿ç¨‹ç›‘å¬ç«¯å£ï¼Œworkerçº¿ç¨‹è´Ÿè´£æ•°æ®è¯»å†™
		ExecutorService boss = Executors.newCachedThreadPool();
		ExecutorService worker = Executors.newCachedThreadPool();
		
	//è®¾ç½®niosocketå·¥å‚
		bootstrap.setFactory(new NioServerSocketChannelFactory(boss, worker));
		//newä¸€ä¸ªå®šæ—¶å™¨
		final HashedWheelTimer hashedWheelTimer = new HashedWheelTimer();
		//è®¾ç½®ç®¡é“çš„å·¥å‚
		bootstrap.setPipelineFactory(new ChannelPipelineFactory() {
			
			@Override
			public ChannelPipeline getPipeline() throws Exception {

				ChannelPipeline pipeline = Channels.pipeline();
				//éœ€è¦åœ¨è¿™é‡Œæ·»åŠ ä¸€ä¸ªå¤„ç†ï¼Œhandleræ‰èƒ½å¤„ç†
				//IdleStateHandlerå‚æ•°ï¼Œå®šæ—¶å™¨ï¼ˆåœ¨ä¸Šé¢å®šä¹‰äº†ï¼Œéœ€è¦newå‡ºæ¥ï¼‰ï¼Œè¯»è¶…æ—¶æ—¶é—´ï¼Œå†™è¶…æ—¶æ—¶é—´ï¼Œè¯»å†™è¶…æ—¶æ—¶é—´ã€‚
				pipeline.addLast("idle", new IdleStateHandler(hashedWheelTimer, 5, 5, 10));
				pipeline.addLast("decoder", new StringDecoder());
				pipeline.addLast("encoder", new StringEncoder());
				pipeline.addLast("helloHandler", new HelloHandler());
				return pipeline;
			}
		});
		
		bootstrap.bind(new InetSocketAddress(10101));
		
		System.out.println("start!!!");
		
	}

}

```
HelloHanler.java

```js
package com.heart;

import org.jboss.netty.channel.ChannelEvent;
import org.jboss.netty.channel.ChannelFuture;
import org.jboss.netty.channel.ChannelFutureListener;
import org.jboss.netty.channel.ChannelHandlerContext;
import org.jboss.netty.channel.MessageEvent;
import org.jboss.netty.channel.SimpleChannelHandler;
import org.jboss.netty.handler.timeout.IdleState;
import org.jboss.netty.handler.timeout.IdleStateEvent;

public class HelloHandler extends SimpleChannelHandler {

	@Override
	public void messageReceived(ChannelHandlerContext ctx, MessageEvent e) throws Exception {
	
		System.out.println(e.getMessage());
	}

	@Override
	public void handleUpstream(final ChannelHandlerContext ctx, ChannelEvent e) throws Exception {
		if (e instanceof IdleStateEvent) {
		//e.getStateè¿”å›çŠ¶æ€ï¼Œå¦‚æœå¤ªä¹…æ²¡æœ‰è¯»ï¼Œå°±ä¼šè¿”å›readï¼Œå¦‚æœå¤ªä¹…æ²¡æœ‰å†™å°±ä¼šè¿”å›writeï¼Œæ²¡æœ‰åº¦ä¹Ÿæ²¡æœ‰å†™è¿”å›ALL_IDE
			if(((IdleStateEvent)e).getState() == IdleState.ALL_IDLE){
				System.out.println("æç¤ºç©å®¶ä¸‹çº¿");
				//å…³é—­ä¼šè¯ï¼Œè¸¢ç©å®¶ä¸‹çº¿
				//å›å†™ç»™ç”¨æˆ·ï¼Œæç¤ºä¼šè¯å°†ä¼šå…³é—­ã€‚
				ChannelFuture write = ctx.getChannel().write("time out, you will close");
				write.addListener(new ChannelFutureListener() {
					
					@Override
					public void operationComplete(ChannelFuture future) throws Exception {
						 ctx.getChannel().close();
					}
				});
			}
		} else {
			super.handleUpstream(ctx, e);
		}
	}

}
```
ç­‰10ç§’ä¸è¯»ä¹Ÿä¸å†™å°±ä¼šè‡ªåŠ¨å…³é—­
## netty5ğŸŒ°
Server.java
```js
package com.heart;

import io.netty.bootstrap.ServerBootstrap;
import io.netty.channel.Channel;
import io.netty.channel.ChannelFuture;
import io.netty.channel.ChannelInitializer;
import io.netty.channel.ChannelOption;
import io.netty.channel.EventLoopGroup;
import io.netty.channel.nio.NioEventLoopGroup;
import io.netty.channel.socket.nio.NioServerSocketChannel;
import io.netty.handler.codec.string.StringDecoder;
import io.netty.handler.codec.string.StringEncoder;
import io.netty.handler.timeout.IdleStateHandler;

/**
 * netty5æœåŠ¡ç«¯
 * @au
 *
 */
public class Server {

	public static void main(String[] args) {
		//æœåŠ¡ç±»
		ServerBootstrap bootstrap = new ServerBootstrap();
		
		//bosså’Œworker
		EventLoopGroup boss = new NioEventLoopGroup();
		EventLoopGroup worker = new NioEventLoopGroup();
		
		try {
			//è®¾ç½®çº¿ç¨‹æ± 
			bootstrap.group(boss, worker);
			
			//è®¾ç½®socketå·¥å‚ã€
			bootstrap.channel(NioServerSocketChannel.class);
			
			//è®¾ç½®ç®¡é“å·¥å‚
			bootstrap.childHandler(new ChannelInitializer<Channel>() {

				@Override
				protected void initChannel(Channel ch) throws Exception {
					ch.pipeline().addLast(new IdleStateHandler(5, 5, 10));
					ch.pipeline().addLast(new StringDecoder());
					ch.pipeline().addLast(new StringEncoder());
					ch.pipeline().addLast(new ServerHandler());
				}
			});
			
			//netty3ä¸­å¯¹åº”è®¾ç½®å¦‚ä¸‹
			//bootstrap.setOption("backlog", 1024);
			//bootstrap.setOption("tcpNoDelay", true);
			//bootstrap.setOption("keepAlive", true);
			//è®¾ç½®å‚æ•°ï¼ŒTCPå‚æ•°
			bootstrap.option(ChannelOption.SO_BACKLOG, 2048);//serverSocketchannelçš„è®¾ç½®ï¼Œé“¾æ¥ç¼“å†²æ± çš„å¤§å°
			bootstrap.childOption(ChannelOption.SO_KEEPALIVE, true);//socketchannelçš„è®¾ç½®,ç»´æŒé“¾æ¥çš„æ´»è·ƒï¼Œæ¸…é™¤æ­»é“¾æ¥
			bootstrap.childOption(ChannelOption.TCP_NODELAY, true);//socketchannelçš„è®¾ç½®,å…³é—­å»¶è¿Ÿå‘é€
			
			//ç»‘å®šç«¯å£
			ChannelFuture future = bootstrap.bind(10101);
			
			System.out.println("start");
			
			//ç­‰å¾…æœåŠ¡ç«¯å…³é—­
			future.channel().closeFuture().sync();
			
		} catch (Exception e) {
			e.printStackTrace();
		} finally{
			//é‡Šæ”¾èµ„æº
			boss.shutdownGracefully();
			worker.shutdownGracefully();
		}
	}
}

```
ServerHandler.java

```js
package com.heart;

import io.netty.channel.ChannelFuture;
import io.netty.channel.ChannelFutureListener;
import io.netty.channel.ChannelHandlerContext;
import io.netty.channel.SimpleChannelInboundHandler;
import io.netty.handler.timeout.IdleState;
import io.netty.handler.timeout.IdleStateEvent;
/**
 * æœåŠ¡ç«¯æ¶ˆæ¯å¤„ç†
 * @
 *
 */
public class ServerHandler extends SimpleChannelInboundHandler<String> {

	@Override
	protected void messageReceived(ChannelHandlerContext ctx, String msg) throws Exception {

		System.out.println(msg);
		
		ctx.channel().writeAndFlush("hi");
		ctx.writeAndFlush("hi");
	}
	
	

	@Override
	public void userEventTriggered(final ChannelHandlerContext ctx, Object evt) throws Exception {
		if(evt instanceof IdleStateEvent){
			IdleStateEvent event = (IdleStateEvent)evt;
			if(event.state() == IdleState.ALL_IDLE){
				
				//æ¸…é™¤è¶…æ—¶ä¼šè¯
				ChannelFuture writeAndFlush = ctx.writeAndFlush("you will close");
				writeAndFlush.addListener(new ChannelFutureListener() {
					
					@Override
					public void operationComplete(ChannelFuture future) throws Exception {
						ctx.channel().close();
					}
				});
			}
		}else{
			super.userEventTriggered(ctx, evt);
		}
	}


	/**
	 * æ–°å®¢æˆ·ç«¯æ¥å…¥
	 */
	@Override
	public void channelActive(ChannelHandlerContext ctx) throws Exception {
		System.out.println("channelActive");
	}

	/**
	 * å®¢æˆ·ç«¯æ–­å¼€
	 */
	@Override
	public void channelInactive(ChannelHandlerContext ctx) throws Exception {
		System.out.println("channelInactive");
	}

	/**
	 * å¼‚å¸¸
	 */
	@Override
	public void exceptionCaught(ChannelHandlerContext ctx, Throwable cause) throws Exception {
		cause.printStackTrace();
	}
	
	
}

```
# æ€»ç»“
1. å¿ƒè·³å…¶å®å°±æ˜¯ä¸€ä¸ªæ™®é€šçš„è¯·æ±‚ï¼Œç‰¹ç‚¹æ•°æ®ç®€å•ï¼Œä¸šåŠ¡ä¹Ÿç®€å•


2. å¿ƒè·³å¯¹äºæœåŠ¡ç«¯æ¥è¯´ï¼Œå®šæ—¶æ¸…é™¤é—²ç½®ä¼šè¯inactive(netty5) channelclose(netty3)

å‡å¦‚å®¢æˆ·ç«¯çªç„¶åœç”µäº†ï¼Œè¿™ä¸ªæ—¶å€™ä¼šè¯ä¿å­˜ç€ï¼Œç„¶åæœ‰ç”µäº†ä¹‹åï¼Œå†æ¬¡è¯·æ±‚ä¼šé‡æ–°å»ºç«‹ä¼šè¯ï¼ŒåŸæ¥çš„ä¼šè¯å°±æˆäº†åƒµå°¸ä¼šè¯ï¼Œéœ€è¦å®šæ—¶å»æ¸…ç†è¿™äº›åƒµå°¸ä¼šè¯ã€‚åå°è¿˜å¯ä»¥è¿”å›ç³»ç»Ÿæ—¶é—´ï¼Œè¾¾åˆ°ä¸€ä¸ªé˜²ä½œå¼Šçš„æ•ˆæœï¼Œå‰ç«¯ä¿®æ”¹ç³»ç»Ÿæ—¶é—´å¯ä»¥è¾¾åˆ°ä¸€ä¸ªæ¸¸æˆåŠ é€Ÿçš„ä½œç”¨ã€‚

3. å¿ƒè·³å¯¹å®¢æˆ·ç«¯æ¥è¯´ï¼Œç”¨æ¥æ£€æµ‹ä¼šè¯æ˜¯å¦æ–­å¼€ï¼Œæ˜¯å¦é‡è¿ï¼ ç”¨æ¥æ£€æµ‹ç½‘ç»œå»¶æ—¶ï¼

æ‰‹æœºappä¸­ç»å¸¸æœ‰æ–­å¼€è¿æ¥ã€é‡æ–°è¿æ¥çš„æ“ä½œã€‚ç©ç‹è€…çš„æ—¶å€™å³ä¸Šè§’æœ‰ä¸€ä¸ªç½‘ç»œå»¶è¿Ÿï¼Œå°±æ˜¯å¿ƒè·³åšçš„ã€‚
