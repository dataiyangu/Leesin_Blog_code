
title: åŸºäºNettyçš„RPCæ¶æ„å­¦ä¹ ç¬”è®°ï¼ˆä¹ï¼‰ï¼šè‡ªå®šä¹‰åºåˆ—åŒ–åè®®
author: Leesin.Dong
top: 
tags:
  - Netty
categories:
  - å­¦ä¹ ç¬”è®°
  - åŸºäºNettyçš„RPCæ¶æ„å­¦ä¹ ç¬”è®°
date: 2019-3-10 10:21:09

---

# ä¸ºä»€ä¹ˆéœ€è¦è‡ªå®šä¹‰åºåˆ—åŒ–åè®®
ä¸ŠèŠ‚ä¸­proto buffæ˜æ˜¾æ¯”javaæœ¬èº«çš„åºåˆ—åŒ–ç”Ÿæˆçš„byteæ•°ç»„çŸ­å¾ˆå¤šï¼Œå› ä¸ºjavaè‡ªèº«çš„åºåˆ—åŒ–ä¼ å…¥äº†å¾ˆå¤šä¿¡æ¯ï¼ˆæ¯”å¦‚ç±»ä¿¡æ¯ã€ç±»å‹ã€å­—æ®µç­‰ï¼‰ï¼Œé€šè¿‡è‡ªå®šä¹‰åºåˆ—åŒ–åè®®èƒ½å¤Ÿé€šè¿‡è‡ªå·±å®šä¹‰çš„æ–¹å¼å®ç°åºåˆ—åŒ–å’Œååºåˆ—åŒ–ã€‚
# ğŸŒ°
## test1

```js
package com.cn;

import java.io.ByteArrayInputStream;
import java.io.ByteArrayOutputStream;
import java.io.IOException;
import java.util.Arrays;

public class Test1 {

	public static void main(String[] args) throws IOException {
		int id = 101;
		int age = 21;
		
		ByteArrayOutputStream arrayOutputStream = new ByteArrayOutputStream();
		//å¸Œæœ›å°†intå†™è¿›å»ï¼Œå¯æ˜¯çœ‹writeçš„æºç è¿”ç°
		//writeï¼ˆint bï¼‰{
		//  buf[coung] = byteï¼ˆbï¼‰
		//	count+=1;
		//}
		//å‘ç°æ˜¯ç›´æ¥æŠŠintè½¬åŒ–æˆäº†byteï¼Œintå æœ‰4ä¸ªå­—èŠ‚é•¿åº¦ï¼Œæ‰€ä»¥è¿™é‡Œå‡ºç°äº†æ•°æ®æˆªæ–­ï¼Œæ‰€ä»¥è‡ªå·±å†™ä¸€ä¸ªæ–¹æ³•int2bytesã€‚
		arrayOutputStream.write(int2bytes(id));
		arrayOutputStream.write(int2bytes(age));
		
		byte[] byteArray = arrayOutputStream.toByteArray();
		
		System.out.println(Arrays.toString(byteArray));
		
		//==============================================================
		ByteArrayInputStream arrayInputStream = new ByteArrayInputStream(byteArray);
		byte[] idBytes = new byte[4];
		arrayInputStream.read(idBytes);
		System.out.println("id:" + bytes2int(idBytes));
		
		byte[] ageBytes = new byte[4];
		arrayInputStream.read(ageBytes);
		System.out.println("age:" + bytes2int(ageBytes));
		
	}
	
	
	/**
	 * å¤§ç«¯å­—èŠ‚åºåˆ—(å…ˆå†™é«˜ä½ï¼Œå†å†™ä½ä½)
	 * ç™¾åº¦ä¸‹ å¤§å°ç«¯å­—èŠ‚åºåˆ—
	 * @param i
	 * @return
	 */
	public static byte[] int2bytes(int i){
		byte[] bytes = new byte[4];
		//ä¸€ä¸ªå­—èŠ‚å…«ä½ï¼Œæ‰€ä»¥3*8
		bytes[0] = (byte)(i >> 3*8);
		bytes[1] = (byte)(i >> 2*8);
		bytes[2] = (byte)(i >> 1*8);
		bytes[3] = (byte)(i >> 0*8);
		return bytes;
	}
	
	
	/**
	 * å¤§ç«¯
	 * @param bytes
	 * @return
	 */
	public static int bytes2int(byte[] bytes){
	//åŸæ¥å‘å³ç§»åŠ¨äº†ä¸‰ä¸ªå­—èŠ‚ï¼Œå¸Œæœ›è¿˜åŸå›æ¥ï¼Œæ‰€ä»¥å‘å·¦ç§»åŠ¨ä¸‰ä¸ªå­—èŠ‚
	//æˆ–è¿ç®—å°±æ˜¯ä¸ºäº†æŠŠæ•°æ®åˆå¹¶èµ·æ¥ï¼Œå˜æˆintæ•°æ®
		return (bytes[0] << 3*8) |
				(bytes[1] << 2*8) |
				(bytes[2] << 1*8) |
				(bytes[3] << 0*8);
				
	}

}

```
è¾“å‡º

```js
[0,0,0,101,0,0,0,21]
id:101
age:21
```
æ¯æ¬¡éƒ½éœ€è¦è¿›è¡Œä½è¿ç®—ï¼Œè€Œä¸”å…ˆåœ¨æ˜¯è½¬æ¢intï¼Œlongã€floatã€doubleè½¬æ¢å‘¢ï¼Ÿ
## test2

```js
package com.cn;

import java.nio.ByteBuffer;
import java.util.Arrays;

public class Test2 {

	public static void main(String[] args) {
		int id = 101;
		int age = 21;
		//é€šè¿‡nioçš„bytebufferè½¬æ¢ï¼Œçœå»äº†ä½è¿ç®—æ–¹æ³•
		//ç”³è¯·å…«ä¸ªç©ºé—´å¤§å°
		ByteBuffer buffer = ByteBuffer.allocate(8);
		buffer.putInt(id);
		buffer.putInt(age);
		byte[] array = buffer.array();
		System.out.println(Arrays.toString(buffer.array()));
		
		//====================================================
		
		ByteBuffer buffer2 = ByteBuffer.wrap(array);
		System.out.println("id:"+buffer2.getInt());
		System.out.println("age:"+buffer2.getInt());
	
	}

}

```
è¾“å‡º

```js
[0,0,0,101,0,0,0,21]
id:101
age:21
```
ç®€åŒ–äº†å¾ˆå¤šæ“ä½œï¼Œä½†æ˜¯

```js
		ByteBuffer buffer = ByteBuffer.allocate(8);
```
å¯æ˜¯æ¯æ¬¡éœ€è¦ç»™å®šç”³è¯·çš„ç»™å®šç©ºé—´å¤§å°ï¼Œä¸èƒ½è‡ªåŠ¨æ‰©å®¹
## test3ï¼ˆä½¿ç”¨nettyä¸­çš„ChannelBuffersï¼‰

```js
package com.cn;

import java.util.Arrays;

import org.jboss.netty.buffer.ChannelBuffer;
import org.jboss.netty.buffer.ChannelBuffers;

public class Test3 {

	public static void main(String[] args) {
	
		ChannelBuffer buffer = ChannelBuffers.dynamicBuffer();
		buffer.writeInt(101);
		buffer.writeDouble(80.1);
	
		byte[] bytes = new byte[buffer.writerIndex()];
		buffer.readBytes(bytes);
		
		System.out.println(Arrays.toString(bytes));
		
		"abc".getBytes();
		
		//================================================
		ChannelBuffer wrappedBuffer = ChannelBuffers.wrappedBuffer(bytes);
		System.out.println(wrappedBuffer.readInt());
		System.out.println(wrappedBuffer.readDouble());
		
	}

}

```
è¾“å‡º

```js
[0,0,0,101,0,0,0,21]
id:101
age:21
```
æ³¨æ„

```js
//channelBufferæ ¹æ®å†™æŒ‡é’ˆçš„ä½ç½®ï¼Œè·å–byteæ•°ç»„å¤§å°
	byte[] bytes = new byte[buffer.writerIndex()];
```
é™¤äº†èƒ½å¤Ÿè‡ªåŠ¨æ‰©å®¹ï¼Œè¿˜èƒ½å¤Ÿè‡ªåŠ¨å†™å…¥int doubleç­‰ç±»å‹ï¼Œå¯æ˜¯è¿˜æ˜¯ä¼˜ç¼ºç‚¹ï¼Œè¿™é‡Œæ²¡æœ‰ä¸€ä¸ªwriteStringçš„æ–¹æ³•

 **<font color="red"> é€šè¿‡â€œabcâ€.getBytes()å¾—åˆ°å­—èŠ‚æ•°æ®ï¼Œå¯æ˜¯æ— æ³•ç¡®å®šå­—èŠ‚çš„å¤§å°ï¼Œä¸åƒintçŸ¥é“æ˜¯å››ä¸ªå­—èŠ‚ï¼Œæ‰€ä»¥String LIst Mapéƒ½éœ€è¦åœ¨å‰é¢åŠ ä¸€ä¸ªé•¿åº¦å­—æ®µã€‚
   </font>**
|-|-|
|-|-|
|String List Map  |  shorté•¿åº¦+å­—èŠ‚æ•°ç»„|

## è‡ªå®šä¹‰åºåˆ—åŒ–åè®®ï¼ˆtest4ï¼‰
SeriaLizer.java (è‡ªå®šä¹‰äº†åºåˆ—åŒ–çš„è§„åˆ™)
```js
package com.serial;


import java.nio.charset.Charset;
import java.util.ArrayList;
import java.util.Collection;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.Map.Entry;
import org.jboss.netty.buffer.ChannelBuffer;
/**
 * è‡ªå®šä¹‰åºåˆ—åŒ–æ¥å£
 * @
 *
 */
public abstract class Serializer {
	
	
	public static final Charset CHARSET = Charset.forName("UTF-8");
	
	protected ChannelBuffer writeBuffer;
	
	protected ChannelBuffer readBuffer;
	
	/**
	 * ååºåˆ—åŒ–å…·ä½“å®ç°
	 */
	protected abstract void read();
	
	/**
	 * åºåˆ—åŒ–å…·ä½“å®ç°
	 */
	protected abstract void write();
	
	/**
	 * ä»byteæ•°ç»„è·å–æ•°æ®
	 * @param bytes	è¯»å–çš„æ•°ç»„
	 */
	public Serializer readFromBytes(byte[] bytes) {
		readBuffer = BufferFactory.getBuffer(bytes);
		read();
		readBuffer.clear();
		return this;
	}
	
	/**
	 * ä»buffè·å–æ•°æ®
	 * @param readBuffer
	 */
	public void readFromBuffer(ChannelBuffer readBuffer) {
		this.readBuffer = readBuffer;
		read();
	}
	
	/**
	 * å†™å…¥æœ¬åœ°buff
	 * @return
	 */
	public ChannelBuffer writeToLocalBuff(){
		writeBuffer = BufferFactory.getBuffer();
		write();
		return writeBuffer;
	}
	
	/**
	 * å†™å…¥ç›®æ ‡buff
	 * @param buffer
	 * @return
	 */
	public ChannelBuffer writeToTargetBuff(ChannelBuffer buffer){
		writeBuffer = buffer;
		write();
		return writeBuffer;
	}
	
	/**
	 * è¿”å›bufferæ•°ç»„
	 * 
	 * @return
	 */
	public byte[] getBytes() {
		writeToLocalBuff();
		byte[] bytes = null;
		if (writeBuffer.writerIndex() == 0) {
			bytes = new byte[0];
		} else {
			bytes = new byte[writeBuffer.writerIndex()];
			writeBuffer.readBytes(bytes);
		}
		writeBuffer.clear();
		return bytes;
	}

	
	public byte readByte() {
		return readBuffer.readByte();
	}

	public short readShort() {
		return readBuffer.readShort();
	}

	public int readInt() {
		return readBuffer.readInt();
	}

	public long readLong() {
		return readBuffer.readLong();
	}

	public float readFloat() {
		return readBuffer.readFloat();
	}

	public double readDouble() {
		return readBuffer.readDouble();
	}
	
	public String readString() {
		int size = readBuffer.readShort();
		if (size <= 0) {
			return "";
		}

		byte[] bytes = new byte[size];
		readBuffer.readBytes(bytes);
	
		return new String(bytes, CHARSET);
	}
	
	public <T> List<T> readList(Class<T> clz) {
		List<T> list = new ArrayList<>();
		int size = readBuffer.readShort();
		for (int i = 0; i < size; i++) {
			list.add(read(clz));
		}
		return list;
	}
	
	public <K,V> Map<K,V> readMap(Class<K> keyClz, Class<V> valueClz) {
		Map<K,V> map = new HashMap<>();
		int size = readBuffer.readShort();
		for (int i = 0; i < size; i++) {
			K key = read(keyClz);
			V value = read(valueClz);
			map.put(key, value);	
		}
		return map;
	}
	
	@SuppressWarnings("unchecked")
	public <I> I read(Class<I> clz) {
		Object t = null;
		if ( clz == int.class || clz == Integer.class) {
			t = this.readInt();
		} else if (clz == byte.class || clz == Byte.class){
			t = this.readByte();
		} else if (clz == short.class || clz == Short.class){
			t = this.readShort();
		} else if (clz == long.class || clz == Long.class){
			t = this.readLong();
		} else if (clz == float.class || clz == Float.class){
			t = readFloat();
		} else if (clz == double.class || clz == Double.class){
			t = readDouble();
		} else if (clz == String.class ){
			t = readString();
		} else if (Serializer.class.isAssignableFrom(clz)){
			try {
				byte hasObject = this.readBuffer.readByte();
				if(hasObject == 1){
					Serializer temp = (Serializer)clz.newInstance();
					temp.readFromBuffer(this.readBuffer);
					t = temp;
				}else{
					t = null;
				}
			} catch (Exception e) {
				e.printStackTrace();
			} 
			
		} else {
			throw new RuntimeException(String.format("ä¸æ”¯æŒç±»å‹:[%s]", clz));
		}
		return (I) t;
	}


	public Serializer writeByte(Byte value) {
		writeBuffer.writeByte(value);
		return this;
	}
	
	public Serializer writeShort(Short value) {
		writeBuffer.writeShort(value);
		return this;
	}
	
	public Serializer writeInt(Integer value) {
		writeBuffer.writeInt(value);
		return this;
	}
	
	public Serializer writeLong(Long value) {
		writeBuffer.writeLong(value);
		return this;
	}
	
	public Serializer writeFloat(Float value) {
		writeBuffer.writeFloat(value);
		return this;
	}
	
	public Serializer writeDouble(Double value) {
		writeBuffer.writeDouble(value);
		return this;
	}
	
	public <T> Serializer writeList(List<T> list) {
		if (isEmpty(list)) {
			writeBuffer.writeShort((short) 0);
			return this;
		}
		writeBuffer.writeShort((short) list.size());
		for (T item : list) {
			writeObject(item);
		}
		return this;
	}
	
	public <K,V> Serializer writeMap(Map<K, V> map) {
		if (isEmpty(map)) {
			writeBuffer.writeShort((short) 0);
			return this;
		}
		writeBuffer.writeShort((short) map.size());
		for (Entry<K, V> entry : map.entrySet()) {
			writeObject(entry.getKey());
			writeObject(entry.getValue());
		}
		return this;
	}
	
	public Serializer writeString(String value) {
		if (value == null || value.isEmpty()) {
			writeShort((short) 0);
			return this;
		}
	
		byte data[] = value.getBytes(CHARSET);
		short len = (short) data.length;
		writeBuffer.writeShort(len);
		writeBuffer.writeBytes(data);
		return this;
	}
	
	public Serializer writeObject(Object object) {
		
		if(object == null){
			writeByte((byte)0);
		}else{


â€‹			
			if (object instanceof Integer) {
				writeInt((int) object);
				return this;
			}
	
			if (object instanceof Long) {
				writeLong((long) object);
				return this;
			}
	
			if (object instanceof Short) {
				writeShort((short) object);
				return this;
			}
	
			if (object instanceof Byte) {
				writeByte((byte) object);
				return this;
			}
	
			if (object instanceof String) {
				String value = (String) object;
				writeString(value);
				return this;
			}
			if (object instanceof Serializer) {
				writeByte((byte)1);
				Serializer value = (Serializer) object;
				value.writeToTargetBuff(writeBuffer);
				return this;
			}
			
			throw new RuntimeException("ä¸å¯åºåˆ—åŒ–çš„ç±»å‹:" + object.getClass());
		}
		
		return this;
	}
	
	private <T> boolean isEmpty(Collection<T> c) {
		return c == null || c.size() == 0;
	}
	public <K,V> boolean isEmpty(Map<K,V> c) {
		return c == null || c.size() == 0;
	}
}

```
æ³¨æ„å…¶ä¸­çš„readStringç­‰æ–¹æ³•

```js
public String readString() {
		int size = readBuffer.readShort();
		if (size <= 0) {
			return "";
		}

		byte[] bytes = new byte[size];
		readBuffer.readBytes(bytes);
	
		return new String(bytes, CHARSET);
	}
```
å°†éœ€è¦çš„Stringï¼ˆlist mapä¸€æ ·ï¼‰çš„byteå¤§å°ä¿å­˜åˆ°readbufferä¸­ï¼Œååºåˆ—åŒ–çš„æ—¶å€™å†ä»é‡Œé¢è¯»å‡ºæ¥ã€‚
BufferFactory.java

```js
package com.serial;


import java.nio.ByteOrder;
import org.jboss.netty.buffer.ChannelBuffer;
import org.jboss.netty.buffer.ChannelBuffers;
/**
 * buffå·¥å‚
 * 
 *
 */
public class BufferFactory {
	
	public static ByteOrder BYTE_ORDER = ByteOrder.BIG_ENDIAN;

	/**
	 * è·å–ä¸€ä¸ªbuffer
	 * 
	 * @return
	 */
	public static ChannelBuffer getBuffer() {
		ChannelBuffer dynamicBuffer = ChannelBuffers.dynamicBuffer();
		return dynamicBuffer;
	}

	/**
	 * å°†æ•°æ®å†™å…¥buffer
	 * @param bytes
	 * @return
	 */
	public static ChannelBuffer getBuffer(byte[] bytes) {
		ChannelBuffer copiedBuffer = ChannelBuffers.copiedBuffer(bytes);
		return copiedBuffer;
	}

}

```
Player.java

```js
package com.serial;

import java.util.ArrayList;
import java.util.List;

/**
 * ç©å®¶å¯¹è±¡
 * 
 */
public class Player extends Serializer{
	
	public Player() {
	}
	
	public Player(long playerId,  int age, String name) {
		this.playerId = playerId;
		this.age = age;
		this.name = name;
	}
	
	private long playerId;
	
	private int age;
	
	private String name;
	
	private List<Integer> skills = new ArrayList<>();

	public long getPlayerId() {
		return playerId;
	}

	public void setPlayerId(long playerId) {
		this.playerId = playerId;
	}

	public int getAge() {
		return age;
	}

	public void setAge(int age) {
		this.age = age;
	}

	public String getName() {
		return name;
	}

	public void setName(String name) {
		this.name = name;
	}

	public List<Integer> getSkills() {
		return skills;
	}

	public void setSkills(List<Integer> skills) {
		this.skills = skills;
	}

	@Override
	protected void read() {
		this.playerId = readLong();
		this.age = readInt();
		this.name = readString();
		this.skills = readList(Integer.class);
	}

	@Override
	protected void write() {
		writeLong(playerId);
		writeInt(age);
		writeString(name);
		writeList(skills);
	}
}

```
test4.java

```js
package com.cn;

import java.util.Arrays;

public class Test4 {

	public static void main(String[] args) {
		
		Player player = new Player();
		player.setPlayerId(10001);
		player.setAge(22);
		player.getSkills().add(101);
		player.getResource().setGold(99999);
		
		byte[] bytes = player.getBytes();
		
		System.out.println(Arrays.toString(bytes));
		
		//==============================================
		
		Player player2 = new Player();
		player2.readFromBytes(bytes);
		System.out.println(player2.getPlayerId() + "   "+player2.getAge() + "     "+ Arrays.toString(player2.getSkills().toArray())+"   " +player2.getResource().getGold());
	
	}

}

```
è¾“å‡º

```js
[0,0,0,0,39,17,0,0ã€‚ã€‚ã€‚ã€‚]
1001 33 101 9999
```
é€šè¿‡Seriazerçš„å°è£…ï¼Œç»“åˆå‰é¢ChannelBuffersçš„æ–¹å¼ï¼Œå°†String list mapéœ€è¦ä¼ å…¥å¤§å°çš„é—®é¢˜è¿›è¡Œäº†ç»“å±€ã€‚
# å¯¹æ¯”åˆ†æprotobuffåŸç† **<font color="red"> é‡ç‚¹å­¦ä¹ protoä½è¿ç®—çš„åŸç†   </font>**
## åˆçª¥
é€šè¿‡ä¸Šé¢çš„ä¾‹å­å’Œä¸ŠèŠ‚çš„protobuffï¼Œä¼ å…¥ç›¸åŒçš„å€¼åˆ°Playerç±»ä¸­

```js
[0,0,0,0,39,17,0,0ã€‚ã€‚ã€‚ã€‚]
1001 33 101 9999
```

```js
[0,0,0,0,39,17]
1001 33 101 9999
```
å½“ç„¶ä¸Šé¢çš„æ•°æ®æ˜¯æˆ‘ç¼–çš„ï¼Œå¯æ˜¯protobuffç”Ÿäº§å‡ºæ¥çš„byteæ•°ç»„å¤§å°ï¼Œæ¯”æˆ‘ä»¬å°½æœ€å¤§åŠªåŠ›è‡ªå®šä¹‰çš„æ•°ç»„å¤§å°è¿˜è¦å°å¾ˆå¤šã€‚
## åˆ†æprotobuffæºç 
ä¸ŠèŠ‚ä¸­çš„ä¾‹å­

```js
Player player = builder.build();
byte[] byteArray = player.toByteArray();
```
æ‰€ä»¥çœ‹tobyteArrayæ–¹æ³•

```js
  public byte[] toByteArray() {
    try {
      final byte[] result = new byte[getSerializedSize()];
      final CodedOutputStream output = CodedOutputStream.newInstance(result);
      writeTo(output);
      output.checkNoSpaceLeft();
      return result;
    } catch (IOException e) {
      throw new RuntimeException(
        "Serializing to a byte array threw an IOException " +
        "(should never happen).", e);
    }
  }
```
çœ‹writeToæ–¹æ³•ï¼ŒwriteToæ˜¯ä¸€ä¸ªæ¥å£æ–¹æ³•ï¼ŒæŸ¥çœ‹å…·ä½“å®ç°ç±»PlayerModule.java
```js
  public void writeTo(com.google.protobuf.CodedOutputStream output)
                        throws java.io.IOException {
      getSerializedSize();
      if (((bitField0_ & 0x00000001) == 0x00000001)) {
        output.writeInt64(1, playerID_);
      }
      if (((bitField0_ & 0x00000002) == 0x00000002)) {
        output.writeInt32(2, age_);
      }
       if (((bitField0_ & 0x00000001) == 0x00000001)) {
        output.writeBytes(3, getNameBytes());
      }
      for (int i = 0; i < skill.size(); i++) {
        output.writeInt32(4, skill.get(i));
      }
      
      getUnknownFields().writeTo(output);
} 
```
è¿™é‡Œçš„writeInt64ç­‰æ–¹æ³•ä¸­çš„ç¬¬ä¸€ä¸ªå‚æ•°1234æ˜¯ä¸ŠèŠ‚ä¸­protoæ–‡ä»¶ä¸­çš„keyï¼Œè¡¨ç¤ºæ˜¯ç¬¬å‡ ä¸ªå­—èŠ‚

```js
	required int64 playerId = 1;
	required int32 age = 2;
	required string name = 3;
	//repeatedçš„æ„æ€æ˜¯listï¼Œé‡å¤intçš„list
	repeated int32 skills = 4;
```
æŸ¥çœ‹WriteInt32æ–¹æ³•

```js
 public void writeInt32(final int fieldNumber, final int value)
                         throws IOException {
  //å†™ç¬¬å‡ ä¸ªå­—èŠ‚
    writeTag(fieldNumber, WireFormat.WIRETYPE_VARINT);
    //å†™å…·ä½“çš„å¹´é¾„
    writeInt32NoTag(value);
  }
```
æŸ¥çœ‹writeInt32NoTagæ–¹æ³•
```js
  public void writeInt32NoTag(final int value) throws IOException {
    if (value >= 0) {
      writeRawVarint32(value);
    } else {
      // Must sign-extend.
      writeRawVarint64(value);
    }
  }
```
æŸ¥çœ‹writeRawVarint32æ–¹æ³•
```js
 public void writeRawVarint32(int value) throws IOException {
    while (true) {
      if ((value & ~0x7F) == 0) {
        writeRawByte(value);
        return;
      } else {
        writeRawByte((value & 0x7F) | 0x80);
        value >>>= 7;
      }
    }
  }
```
0x7F è½¬åŒ–æˆäºŒè¿›åˆ¶ 0111 1111
~0x7F å–åå 1000 0000
value& ~0x7F çš„ç»“æœå°±æ˜¯valueçš„1-7ä½éƒ½è¢«ç½®ä¸ºäº†0ï¼Œvalueæ˜¯32ä½ï¼Œå‰é¢è¿˜æœ‰25ä½å¯èƒ½æœ‰æ•°æ®ï¼Œæ‰€ä»¥å¯èƒ½value & ~0x7F !=  0
æ‰€ä»¥å¦‚æœvalue & ~0x7F == 0ï¼Œè¯´æ˜valueå€¼çš„å¤§å°æ˜¯å°äº7ä½çš„

å¦‚æœå°äºåé¢7ä½çš„å¤§å°ï¼Œå°±å†™ä¸€ä¸ªå­—èŠ‚çš„æ•°æ®

```js
 public void writeRawByte(final byte value) throws IOException {
    if (position == limit) {
      refreshBuffer();
    }
```
å¦‚æœå¤§äºåé¢7ä½çš„å¤§å°

```js
 writeRawByte((value & 0x7F) | 0x80);
 value >>>= 7;
```
value & 0x7Fè·å–1-7ä½æ•°æ®
0x80è¡¨ç¤ºæˆäºŒè¿›åˆ¶1000 0000
æˆ–è¿ç®— 1xxx xxxx é€šè¿‡ç¬¬å…«ä½åˆ¤æ–­åé¢è¿˜æœ‰æ²¡æœ‰æ•°æ®ï¼Œå¦‚æœæœ‰æ•°æ®å°±æ˜¯1ï¼Œå¦‚æœæ²¡æœ‰æ•°æ®å°±æ˜¯0ï¼Œ
æ‰€ä»¥è¿™é‡Œè¯´æ˜æœ‰æ•°æ®ï¼Œå¾€å³ç§»7ä½ï¼Œæ¥ç€è¯»ï¼Œç„¶ååœ¨æ­¤åˆ¤æ–­å‰©ä¸‹çš„æ•°æ®æ˜¯ä¸æ˜¯å°äºä¸ƒä½ï¼Œå¦‚æ­¤å¾ªç¯ã€‚ 

å› ä¸ºè¿™é‡Œçš„ç¬¬ä¸€ä½ç”¨æ¥è¡¨ç¤ºè¿˜æœ‰æ²¡æœ‰æ•°æ®ï¼Œæ‰€ä»¥åªèƒ½è¡¨ç¤º28ä½çš„æ•°æ®ä½ï¼Œè€ŒçœŸæ­£éœ€è¦è¡¨ç¤ºçš„æ˜¯32ä½ï¼Œæ‰€ä»¥è¿˜éœ€è¦ä¸€ä¸ªå­—èŠ‚å­˜å‚¨ä¸¢å¤±çš„4ä½ï¼Œæ‰€ä»¥int çš„å­—èŠ‚é•¿åº¦ä¸æ˜¯ä¼ ç»Ÿçš„4ä¸ªï¼Œåœ¨protoä¸­ä¸ºä¼¸ç¼©çš„1-5ä¸ªå­—èŠ‚ï¼Œlongä¸æ˜¯ä¼ ç»Ÿçš„8ä½ï¼Œåœ¨protoä¸­æ˜¯ä¼¸ç¼©çš„1-9ä½
