
title: åŸºäºNettyçš„RPCæ¶æ„å­¦ä¹ ç¬”è®°ï¼ˆå››ï¼‰ï¼šnettyçº¿ç¨‹æ¨¡å‹æºç åˆ†æï¼ˆä¸€ï¼‰
author: Leesin.Dong
top: 
tags:
  - Netty
categories:
  - å­¦ä¹ ç¬”è®°
  - åŸºäºNettyçš„RPCæ¶æ„å­¦ä¹ ç¬”è®°
date: 2019-3-10 10:21:04

---

# å¦‚ä½•æé«˜NIOçš„å·¥ä½œæ•ˆç‡


## ä¸¾ä¸ªğŸŒ°
å‰é¢ç¬¬ä¸€èŠ‚ä¸­çš„NIOä»£ç 
```js
public void listen() throws IOException {
		System.out.println("æœåŠ¡ç«¯å¯åŠ¨æˆåŠŸï¼");
		// è½®è¯¢è®¿é—®selector
		while (true) {
			// å½“æ³¨å†Œçš„äº‹ä»¶åˆ°è¾¾æ—¶ï¼Œæ–¹æ³•è¿”å›ï¼›å¦åˆ™,è¯¥æ–¹æ³•ä¼šä¸€ç›´é˜»å¡
			//ç‚¹ä¸è¿›å»selectæ–¹æ³•ï¼Œå› ä¸ºåº•å±‚æ˜¯cå†™çš„
			selector.select();
			// è·å¾—selectorä¸­é€‰ä¸­çš„é¡¹çš„è¿­ä»£å™¨ï¼Œé€‰ä¸­çš„é¡¹ä¸ºæ³¨å†Œçš„äº‹ä»¶
			Iterator<?> ite = this.selector.selectedKeys().iterator();
			while (ite.hasNext()) {
				SelectionKey key = (SelectionKey) ite.next();
				// åˆ é™¤å·²é€‰çš„key,ä»¥é˜²é‡å¤å¤„ç†
				ite.remove();
				handler(key);
			}
		}
	}
```
ä»…ä»…ä¿®æ”¹æˆ

```js
public void listen() throws IOException {
		System.out.println("æœåŠ¡ç«¯å¯åŠ¨æˆåŠŸï¼");
		// è½®è¯¢è®¿é—®selector
		while (true) {
			// å½“æ³¨å†Œçš„äº‹ä»¶åˆ°è¾¾æ—¶ï¼Œæ–¹æ³•è¿”å›ï¼›å¦åˆ™,è¯¥æ–¹æ³•ä¼šä¸€ç›´é˜»å¡
			//ç‚¹ä¸è¿›å»selectæ–¹æ³•ï¼Œå› ä¸ºåº•å±‚æ˜¯cå†™çš„
			selector.select();
			// è·å¾—selectorä¸­é€‰ä¸­çš„é¡¹çš„è¿­ä»£å™¨ï¼Œé€‰ä¸­çš„é¡¹ä¸ºæ³¨å†Œçš„äº‹ä»¶
			Iterator<?> ite = this.selector.selectedKeys().iterator();
			while (ite.hasNext()) {
				SelectionKey key = (SelectionKey) ite.next();
				// åˆ é™¤å·²é€‰çš„key,ä»¥é˜²é‡å¤å¤„ç†
				ite.remove();
				newCachedThreadPool.execute(new Runnable(){
					@Override
					public void run(){
					handler(key);
					}
				})

			}
		}
	}
```

```js
public void handlerAccept(SelectionKey key) throws IOException {
		ServerSocketChannel server = (ServerSocketChannel) key.channel();
		// è·å¾—å’Œå®¢æˆ·ç«¯è¿æ¥çš„é€šé“ï¼ŒSocketChannelç›¸å½“äºä¼ ç»Ÿioé‡Œé¢çš„Channel
		SocketChannel channel = server.accept();
		// è®¾ç½®æˆéé˜»å¡
		channel.configureBlocking(false);

		// åœ¨è¿™é‡Œå¯ä»¥ç»™å®¢æˆ·ç«¯å‘é€ä¿¡æ¯å“¦
		System.out.println("æ–°çš„å®¢æˆ·ç«¯è¿æ¥");
		// åœ¨å’Œå®¢æˆ·ç«¯è¿æ¥æˆåŠŸä¹‹åï¼Œä¸ºäº†å¯ä»¥æ¥æ”¶åˆ°å®¢æˆ·ç«¯çš„ä¿¡æ¯ï¼Œéœ€è¦ç»™é€šé“è®¾ç½®è¯»çš„æƒé™ã€‚
		channel.register(this.selector, SelectionKey.OP_READ);
	}
```

ç„¶åé€šè¿‡telnetè¯·æ±‚ä¸€ä¸‹

æŠ¥é”™ï¼Œç©ºæŒ‡é’ˆå¼‚å¸¸ï¼Œå› ä¸ºè™½ç„¶ite.removeï¼Œå¯æ˜¯åœ¨handlerï¼ˆkeyï¼‰è¿˜æ²¡æœ‰å¤„ç†å®Œçš„æ—¶å€™å°±è¿”å›äº†ï¼Œæ²¡æœ‰å¤„ç†selectæ–¹æ³•å¹¶ä¸ä¸ä¼šé˜»å¡ï¼Œæ‰€ä»¥ä¸‹æ¬¡è¿˜æ˜¯è¿™ä¸ªkeyå»è®¿é—®selector.select()ï¼Œthis.selector.selectedKeys()è¿˜æ˜¯åˆšæ‰çš„å®¢æˆ·ç«¯ï¼Œç„¶åå†è¿›è¡Œä¸€æ¬¡handlerï¼Œä¹Ÿå°±æ˜¯è¿™ä¸ªketåˆè¿›è¡Œäº†ä¸€æ¬¡acceptï¼ŒåŒä¸€ä¸ªkey acceptäº†ä¸¤æ¬¡ã€‚
çœ‹åˆ°ä¸Šé¢çš„handleracceptæ–¹æ³•ï¼Œç¬¬ä¸€æ¬¡å·²ç»acceptåˆ°äº†å®¢æˆ·ç«¯ï¼Œæ‰€ä»¥ç¬¬äºŒæ¬¡acceptçš„æ—¶å€™å°±è·å–ä¸åˆ°äº†

```js
SocketChannel channel = server.accept();
```
è·å–ä¸åˆ°channelï¼Œè¿™è¡Œä»£ç çš„ä¸‹é¢å°±æŠ›å‡ºäº†ç©ºæŒ‡é’ˆå¼‚å¸¸ã€‚

 **<font color="red"> ç»¼ä¸Šï¼šNIOçš„å¤šçº¿ç¨‹ä¸èƒ½é€šè¿‡ä¸Šé¢çš„æ–¹å¼   </font>**

##  å°é—®é¢˜
###  ä¸€ä¸ªNIOæ˜¯ä¸æ˜¯åªèƒ½æœ‰ä¸€ä¸ªselectorï¼Ÿ

ä¸æ˜¯ï¼Œä¸€ä¸ªç³»ç»Ÿå¯ä»¥æœ‰å¤šä¸ªselector

###  selectoræ˜¯ä¸æ˜¯åªèƒ½æ³¨å†Œä¸€ä¸ªServerSocketChannelï¼Ÿ

ä¸æ˜¯ï¼Œå¯ä»¥æ³¨å†Œå¤šä¸ª

```js
serverSocketChannel.register(selector, SelectionKey.OP_ACCEPT);
scocketchannel.register(this.selector, SelectionKey.OP_READ);
```
selectoræ—¢è¦è´Ÿè´£å¤§é—¨ï¼Œåˆè¦è´Ÿè´£æ¯ä¸ªå®¢äººç‚¹èœçš„éœ€æ±‚
## å›¾è¯´NettyIO
socketIO
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](../images/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RhdGFpeWFuZ3U=,size_16,color_FFFFFF,t_70-20190312195226359.png)
NIO
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](../images/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RhdGFpeWFuZ3U=,size_16,color_FFFFFF,t_70-20190312195423240.png)
NettyIO
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](../images/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RhdGFpeWFuZ3U=,size_16,color_FFFFFF,t_70-20190312195437178.png)
éšç€é¤å…è§„æ¨¡çš„è¶Šæ¥è¶Šå¤§ï¼Œéœ€è¦æ›´å¤šçš„æœåŠ¡ç”Ÿï¼Œå¦‚ä½•åˆ†é…è¿™äº›æœåŠ¡ç”Ÿå‘¢ï¼Ÿæ¯ä¸ªæœåŠ¡ç”Ÿåˆ†é…åˆ°ä¸åŒçš„åŒºåŸŸï¼Œç®¡ç†ä¸åŒçš„åŒºåŸŸï¼Œå¤§é—¨çš„åœ°æ–¹ä¹Ÿå¯ä»¥åˆ†é…ä¸€ä¸ªæœåŠ¡ç”Ÿã€‚

# å¦‚ä½•æ„å»ºä¸€ä¸ªå¤šçº¿ç¨‹çš„NIOç³»ç»Ÿ(ğŸŒ°æºç è§£è¯»)
ä¸‹é¢æ˜¯ä¸€ä¸ªç²¾ç®€äº†Nettyæºç çš„å°ä¾‹å­ï¼ˆä»Nettyä¸­æŠ½å–éƒ¨åˆ†ä»£ç å¹¶æ•´åˆï¼‰
ä»£ç ç»“æ„ï¼š
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](../images/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RhdGFpeWFuZ3U=,size_16,color_FFFFFF,t_70-20190312195226743.png)
start.java
```js
package com.cn;

import java.net.InetSocketAddress;
import java.util.concurrent.Executors;
import com.cn.pool.NioSelectorRunnablePool;
/**

- å¯åŠ¨å‡½æ•°

- 
   */
public class Start {
 public static void main(String[] args) {
  //åˆå§‹åŒ–çº¿ç¨‹
  //NioSelectorRunnablePoolæ˜¯ç”¨æ¥ç®¡ç†çº¿ç¨‹æ± çš„
  //ç»™äº†ä¸¤ä¸ªçº¿ç¨‹æ± ä¸€ä¸ªbossï¼Œä¸€ä¸ªworker
  //newCachedThreadPool ç¼“å­˜çš„çº¿ç¨‹æ± ï¼Œå½“ä¸€ä¸‹å­å¥½å¤šä»»åŠ¡çš„æ—¶å€™ï¼Œå°±å¼€å¥½å¤šçº¿ç¨‹å»åšï¼Œå¦‚æœæ²¡æœ‰ä»»åŠ¡
  //çš„æ—¶å€™ï¼Œçº¿ç¨‹ç©ºé—²ä¸‹æ¥çš„æ—¶å€™ï¼Œæ…¢æ…¢çº¿ç¨‹çš„æ•°é‡å°±ä¼šå‡å°‘ï¼Œè‡ªç„¶æ¶ˆäº¡ï¼Œç®€è€Œè¨€ä¹‹å°±æ˜¯çº¿ç¨‹çš„æ•°é‡åœ¨æŸæ®µæ—¶
  //é—´å†…æ˜¯ä¼šæ‰©å¼ æˆ–è€…æ”¶ç¼©çš„
  //è¿™ä¸ªç±»çš„æ„é€ å‡½æ•°åœ¨ä¸‹é¢çš„NioSelectorRunnablePool.java
  NioSelectorRunnablePool nioSelectorRunnablePool = new NioSelectorRunnablePool(Executors.newCachedThreadPool(), Executors.newCachedThreadPool()); 
  //è·å–æœåŠ¡ç±»ï¼Œå°†çº¿ç¨‹ç®¡ç†è€…äº¤ç»™æœåŠ¡ç±»
  //å…·ä½“çœ‹ServerBoosTrap.java
  ServerBootstrap bootstrap = new ServerBootstrap(nioSelectorRunnablePool);  
  //ç»‘å®šç«¯å£å…·ä½“çœ‹ServerBoosTrap.java
  bootstrap.bind(new InetSocketAddress(10101));
  System.out.println("start");
  }
}
```
NioSelectorRunnablePool.java
```js
package com.cn.pool;

import java.util.concurrent.Executor;
import java.util.concurrent.atomic.AtomicInteger;
import com.cn.NioServerBoss;
import com.cn.NioServerWorker;
/**

- selectorçº¿ç¨‹ç®¡ç†è€…

-
  *
   */
  public class NioSelectorRunnablePool {

  /**

  - bossçº¿ç¨‹æ•°ç»„
    */
    private final AtomicInteger bossIndex = new AtomicInteger();
    private Boss[] bosses;

  /**

  - workerçº¿ç¨‹æ•°ç»„
    */
    private final AtomicInteger workerIndex = new AtomicInteger();
    private Worker[] workeres;

  public NioSelectorRunnablePool(Executor boss, Executor worker) {
  //åˆå§‹åŒ–çº¿ç¨‹æ± bossï¼Œé»˜è®¤æ˜¯1çš„æ•°é‡
  //å¾€ä¸‹ä¸€ç‚¹ç‚¹æ˜¯initBossè¿™ä¸ªæ–¹æ³•
  	initBoss(boss, 1);
  	//åˆå§‹åŒ–workerï¼Œä¼ å…¥workerçº¿ç¨‹æ± ï¼Œæ•°é‡æ˜¯ç³»ç»Ÿçš„æ ¸å¿ƒæ•°é‡*2
  	//å¾€ä¸‹çœ‹initWorkeræ–¹æ³•
  	initWorker(worker, Runtime.getRuntime().availableProcessors() * 2);
  }

  /**

  - åˆå§‹åŒ–bossçº¿ç¨‹
  - @param boss
  - @param count
    */
    private void initBoss(Executor boss, int count) {
    //NioServerBossåœ¨ä¸‹é¢NioServerBoss.javaé‡Œé¢
    this.bosses = new NioServerBoss[count];
    for (int i = 0; i < bosses.length; i++) {
    //å›åˆ°è¿™é‡Œå¯¹æ¯ä¸€ä¸ªbossåˆå§‹åŒ–
    //æ„é€ æ–¹æ³•åœ¨ä¸‹é¢
    	bosses[i] = new NioServerBoss(boss, "boss thread " + (i+1), this);
    }

  }

  /**

  - åˆå§‹åŒ–workerçº¿ç¨‹
  - @param worker
  - @param count
    */
    private void initWorker(Executor worker, int count) {
    this.workeres = new NioServerWorker[count];
    for (int i = 0; i < workeres.length; i++) {
    //NioServerWorkeråœ¨ä¸‹é¢
    	workeres[i] = new NioServerWorker(worker, "worker thread " + (i+1), this);
    }
    }

  /**

  - è·å–ä¸€ä¸ªworker
  - @return
    */
    public Worker nextWorker() {
     return workeres[Math.abs(workerIndex.getAndIncrement() % workeres.length)];

  }

  /**

  - è·å–ä¸€ä¸ªboss
  - @return
    */
    public Boss nextBoss() {
     return bosses[Math.abs(bossIndex.getAndIncrement() % bosses.length)];
    }

}
```
NioServerBoss,java
```js
package com.cn;

import java.io.IOException;
import java.nio.channels.ClosedChannelException;
import java.nio.channels.SelectionKey;
import java.nio.channels.Selector;
import java.nio.channels.ServerSocketChannel;
import java.nio.channels.SocketChannel;
import java.util.Iterator;
import java.util.Set;
import java.util.concurrent.Executor;

import com.cn.pool.Boss;
import com.cn.pool.NioSelectorRunnablePool;
import com.cn.pool.Worker;
/**

- bosså®ç°ç±»

- 
  *
   */
   //AbstractNioSelectoråœ¨ä¸‹é¢AbstractNioSelector.javaè¿™ä¸ªç±»æ˜¯selectorçš„ä¸€ä¸ªæŠ½è±¡ç±»
   //ä¸ºä»€ä¹ˆè¦æ˜¯æŠ½è±¡ç±»ï¼Ÿ
   //åœ¨é—¨å£çš„æœåŠ¡ç”Ÿå’Œåœ¨é‡Œé¢ä¸ºå®¢äººæœåŠ¡çš„æœåŠ¡ç”Ÿæœ‰å¾ˆå¤šå…±åŒç‚¹ï¼Œæ¯”å¦‚å…³æ³¨å¤šä¸ªåœ°æ–¹ï¼Œç©¿ç€ä¸€æ ·
   //ä½†æ˜¯è¿˜æœ‰å¾ˆå¤šä¸åŒçš„åœ°æ–¹ï¼Œæ¯”å¦‚å¤§é—¨å£çš„æœåŠ¡ç”Ÿè¯´æ¬¢è¿å…‰ä¸´ï¼Œå¤§å…çš„æœåŠ¡ç”Ÿçœ‹å“ªé‡Œæœ‰ç‚¹èœçš„éœ€æ±‚
  public class NioServerBoss extends AbstractNioSelector implements Boss{
  public NioServerBoss(Executor executor, String threadName, NioSelectorRunnablePool selectorRunnablePool) {
  //è°ƒåŠ¨çš„æ˜¯å…¶çˆ¶ç±»AbstractNioSelectorçš„æ„é€ æ–¹æ³•ï¼Œå¾€ä¸‹çœ‹
  	super(executor, threadName, selectorRunnablePool);
  }
  @Override
  protected void process(Selector selector) throws IOException {
  	Set<SelectionKey> selectedKeys = selector.selectedKeys();
      if (selectedKeys.isEmpty()) {
          return;
      }
	  for (Iterator<SelectionKey> i = selectedKeys.iterator(); i.hasNext();) {
      SelectionKey key = i.next();
      i.remove();
      ServerSocketChannel server = (ServerSocketChannel) key.channel();
  	//accept æ–°å®¢æˆ·ç«¯
  	SocketChannel channel = server.accept();
  	// è®¾ç½®ä¸ºéé˜»å¡
  	channel.configureBlocking(false);
  	// é€šè¿‡çº¿ç¨‹ç®¡ç†è€…ï¼Œè·å–ä¸€ä¸ªworkerï¼Œ
  	//é—¨å£çš„æœåŠ¡ç”Ÿå¼•å…¥å®¢äººåè¦å¸¦åˆ°æŸä¸ªåŒºåŸŸçš„workerèº«è¾¹ï¼Œå‘Šè¯‰ä»–ä½ è¦è´Ÿè´£è¿™ä½å®¢äººã€‚
  	Worker nextworker = getSelectorRunnablePool().nextWorker();
  	// æ³¨å†Œæ–°å®¢æˆ·ç«¯æ¥å…¥ä»»åŠ¡
  	//è´Ÿè´£å¤§å…çš„æœåŠ¡ç”Ÿç»™è‡ªå·±æ³¨å†Œä»»åŠ¡
  	//registerNewChannelTaskå…·ä½“çš„å®ç°çœ‹ä¸‹é¢çš„NioServerWorkerç±»
  	//å°†å½“å‰çš„å®¢æˆ·ç«¯æ³¨å†Œç»™selector readäº‹ä»¶
  	//è¿™ä¹ˆåšçš„å¥½å¤„æ˜¯ä»€ä¹ˆï¼Ÿï¼Ÿï¼Ÿæœ‰æ•ˆçš„è§£å†³é«˜å¹¶å‘
  	//å¾€åˆ«çš„é˜Ÿåˆ—é‡Œé¢åŠ ä»»åŠ¡ï¼Œè€Œä¸æ˜¯ç›´æ¥å»æ“ä½œä½ çš„ä¸œè¥¿ï¼Œä½ è‡ªå·±å»å¤„ç†è¿™ä¸ªä»»åŠ¡ï¼Œ
  	nextworker.registerNewChannelTask(channel);
  	
  	System.out.println("æ–°å®¢æˆ·ç«¯é“¾æ¥");
  }
  }
  public void registerAcceptChannelTask(final ServerSocketChannel serverChannel){
  	 final Selector selector = this.selector;
  	 //æ³¨å†Œå®Œä¸‹é¢çš„äº‹ä»¶ä¹‹åï¼Œæ‰§è¡ŒregisterTaskï¼Œå…·ä½“çœ‹AbstractNioSelector.java
  	 //ç®€è€Œè¨€ä¹‹å°±æ˜¯æŠŠä»»åŠ¡æ”¾å…¥é˜Ÿåˆ—ï¼Œå¹¶wakenup
  	 registerTask(new Runnable() {
  		@Override
  		public void run() {
  			try {
  				//æ³¨å†ŒserverChannelï¼Œacceptåˆ°selector
  				serverChannel.register(selector, SelectionKey.OP_ACCEPT);
  			} catch (ClosedChannelException e) {
  				e.printStackTrace();
  			}
  		}
  	});
  }
  @Override
  protected int select(Selector selector) throws IOException {
  	return selector.select();
  }
}
```
AbstractNioSelector.java
```js
package com.cn;
import java.io.IOException;
import java.nio.channels.Selector;
import java.util.Queue;
import java.util.concurrent.ConcurrentLinkedQueue;
import java.util.concurrent.Executor;
import java.util.concurrent.atomic.AtomicBoolean;
import com.cn.pool.NioSelectorRunnablePool;
/**
- æŠ½è±¡selectorçº¿ç¨‹ç±»
- 
- */
  public abstract class AbstractNioSelector implements Runnable {
  /**
  - çº¿ç¨‹æ± 
    */
    private final Executor executor;
  /**
  - é€‰æ‹©å™¨
    */
    protected Selector selector;
/**
  - é€‰æ‹©å™¨wakenUpçŠ¶æ€æ ‡è®°
    */
    protected final AtomicBoolean wakenUp = new AtomicBoolean();
  /**
 - ä»»åŠ¡é˜Ÿåˆ—
    */
    private final Queue<Runnable> taskQueue = new ConcurrentLinkedQueue<Runnable>();
  /**
  - çº¿ç¨‹åç§°
    */
    private String threadName;
  /**
  - çº¿ç¨‹ç®¡ç†å¯¹è±¡
    */
    protected NioSelectorRunnablePool selectorRunnablePool;
    //çº¿ç¨‹æ± ã€çº¿ç¨‹åã€çº¿ç¨‹ç®¡ç†è€…
  AbstractNioSelector(Executor executor, String threadName, NioSelectorRunnablePool selectorRunnablePool) {
  	this.executor = executor;
  	this.threadName = threadName;
  	this.selectorRunnablePool = selectorRunnablePool;
  	//æœ€åopenSelectorï¼Œå¾€ä¸‹çœ‹å¾€æ¯ä¸€ä¸ªçº¿ç¨‹é‡Œé¢åŠ å…¥äº†selectorè¿™ä¸ªä¸œè¥¿
  	//ä¸€ä¸ªçº¿ç¨‹åŠ ä¸€ä¸ªselectoræ‰æœ‰ä¸ºå¤šä¸ªå®¢äººæœåŠ¡çš„èƒ½åŠ›ã€‚
  	openSelector();
  }
  /**
  - è·å–selectorå¹¶å¯åŠ¨çº¿ç¨‹
    */
    private void openSelector() {
    try {
    	this.selector = Selector.open();
    } catch (IOException e) {
    	throw new RuntimeException("Failed to create a selector.");
    }
    //ç”¨çº¿ç¨‹æ± æ‰§è¡Œå½“å‰å¯¹è±¡ï¼Œè¿è¡Œå½“å‰çº¿ç¨‹
    //è¿™é‡Œçš„thiså°±æ˜¯bosses[i] = new NioServerBoss(boss, "boss thread " + (i+1), this);
    //ç»§æ‰¿AbstractNioSelectåˆå®ç°äº†Runnableï¼Œæ‰€ä»¥æœ‰ä¸€ä¸ªrunæ–¹æ³•ï¼Œçœ‹ä¸‹é¢
    executor.execute(this);
    }
  @Override
  public void run() {
  //ç»™å½“å‰çº¿ç¨‹èµ‹ä¸€ä¸ªåå­—
  Thread.currentThread().setName(this.threadName);
  //è¿™é‡Œæ˜¯æœ€æ ¸å¿ƒçš„ï¼Œçœ‹å®Œè¿™é‡Œå›å»çœ‹NioSelectorRunnablePoolçš„initWorker
  while (true) {
  	try {
  		wakenUp.set(false);  
  		//selectorçš„æŠ½è±¡æ–¹æ³•æœ‰ä¸¤ä¸ªå®ç°
  		//boosä¸­return selector.select();ç›´æ¥é˜»å¡äº†
  		//workerä¸­return selector.select(500);è¶…æ—¶æ—¶é—´500
  		select(selector);
  		//æ‰§è¡Œé˜Ÿåˆ—ä¸­çš„ä»»åŠ¡
  		//æ–¹æ³•åœ¨ä¸‹é¢
  		processTaskQueue(); 
  		//æŠ½è±¡æ–¹æ³•è¢«bosså’Œworkerå®ç°ï¼Œå…·ä½“å®ç°çœ‹ä¸Šé¢çš„NioServerBosså’Œä¸‹é¢çš„NioServerWorker
  		process(selector);
  	} catch (Exception e) {
  		// ignore
  	}
  }
  }
  /**
  - æ³¨å†Œä¸€ä¸ªä»»åŠ¡å¹¶æ¿€æ´»selector
  - 
  - @param task
    */
//ç®€è€Œè¨€ä¹‹å°±æ˜¯æŠŠä»»åŠ¡æ”¾å…¥é˜Ÿåˆ—ï¼Œå¹¶wakenup
    protected final void registerTask(Runnable task) {
    //å¾€é˜Ÿåˆ—ä¸­åŠ äº†ä»»åŠ¡
    taskQueue.add(task);
    Selector selector = this.selector;
    if (selector != null) {
    //wakenUpæ˜¯ä¸€ä¸ªåŸå­çš„ç±»ï¼ŒconpareAndSetï¼Œçœ‹ä»–æ˜¯ä¸æ˜¯falseï¼Œæ˜¯falseçš„è¯å°±è®¾ç½®ä¸ºtrue
    	if (wakenUp.compareAndSet(false, true)) {
    	//åŠ å…¥ä¸€ä¸ªæ–°çš„å®¢æˆ·ç«¯ï¼Œè¦ç«‹é©¬æ¿€æ´»selectorçš„é˜»å¡çŠ¶æ€ï¼Œå³å¦‚æœåŸæ¥selectæˆ–selectï¼ˆlongï¼‰
    	//è¢«é˜»å¡ï¼Œè°ƒç”¨è¿™ä¸ªæ–¹æ³•å°†å…¶ç«‹é©¬è¿”å›ã€‚
    	//å¯ä»¥çœ‹åˆ°ä¸Šé¢å“ªä¸ªæ–¹æ³•é‡ŒwakenUp.set(false);  
    	//çœ‹å®Œè¿™é‡Œå›å»æ¥ç€çœ‹mainæ–¹æ³•ä¸­çš„ç¬¬äºŒè¡ŒServerBootstrap
    		selector.wakenup();
    	}
    } else {
    	taskQueue.remove(task);
    }
    }
  /**

  - æ‰§è¡Œé˜Ÿåˆ—é‡Œçš„ä»»åŠ¡
    */
    private void processTaskQueue() {
    for (;;) {
    	final Runnable task = taskQueue.poll();
    	if (task == null) {
    		break;
    	}
    	task.run();
    }
    }
  /**
  - è·å–çº¿ç¨‹ç®¡ç†å¯¹è±¡
  - @return
    */
    public NioSelectorRunnablePool getSelectorRunnablePool() {
    return selectorRunnablePool;
    }
  /**
  - selectæŠ½è±¡æ–¹æ³•
  - 
  - @param selector
  - @return
  - @throws IOException
    */
    protected abstract int select(Selector selector) throws IOException;

  /**
  - selectorçš„ä¸šåŠ¡å¤„ç†
  - 
  - @param selector
  - @throws IOException
    */
    protected abstract void process(Selector selector) throws IOException;

}
```
NioServerWorker.java

```js
package com.cn;

import java.io.IOException;
import java.nio.ByteBuffer;
import java.nio.channels.ClosedChannelException;
import java.nio.channels.SelectionKey;
import java.nio.channels.Selector;
import java.nio.channels.SocketChannel;
import java.util.Iterator;
import java.util.Set;
import java.util.concurrent.Executor;

import com.cn.pool.NioSelectorRunnablePool;
import com.cn.pool.Worker;
/**

- workerå®ç°ç±»

- 
  *
   */
   //å’ŒNioServerBossæ˜¯ä¸€æ ·çš„ç»§æ‰¿AbstractNioSelector
  public class NioServerWorker extends AbstractNioSelector implements Worker{
  //å’ŒNioServerBossæ˜¯ä¸€æ ·çš„è¿è¡Œçˆ¶ç±»çš„æ„é€ æ–¹æ³•
  //è·³è½¬åˆ°ä¸Šé¢çš„AbstractNioSelectorç±»çš„æ„é€ æ–¹æ³•
  public NioServerWorker(Executor executor, String threadName, NioSelectorRunnablePool selectorRunnablePool) {
  	super(executor, threadName, selectorRunnablePool);
  }

  @Override
  protected void process(Selector selector) throws IOException {
  	Set<SelectionKey> selectedKeys = selector.selectedKeys();
      if (selectedKeys.isEmpty()) {
          return;
      }
      Iterator<SelectionKey> ite = this.selector.selectedKeys().iterator();
  	while (ite.hasNext()) {
  		SelectionKey key = (SelectionKey) ite.next();
  		// ç§»é™¤ï¼Œé˜²æ­¢é‡å¤å¤„ç†
  		ite.remove();
	  	// å¾—åˆ°äº‹ä»¶å‘ç”Ÿçš„Socketé€šé“
	  	SocketChannel channel = (SocketChannel) key.channel();
	  	// æ•°æ®æ€»é•¿åº¦
	  	int ret = 0;
	  	boolean failure = true;
	  	ByteBuffer buffer = ByteBuffer.allocate(1024);
	  	//è¯»å–æ•°æ®
	  	try {
	  		ret = channel.read(buffer);
	  		failure = false;
	  	} catch (Exception e) {
	  		// ignore
	  	}
	  	//åˆ¤æ–­æ˜¯å¦è¿æ¥å·²æ–­å¼€
	  	if (ret <= 0 || failure) {
	  		key.cancel();
	  		System.out.println("å®¢æˆ·ç«¯æ–­å¼€è¿æ¥");
	      }else{
	      	 System.out.println("æ”¶åˆ°æ•°æ®:" + new String(buffer.array()));	 
	   		//å›å†™æ•°æ®
	   		ByteBuffer outBuffer = ByteBuffer.wrap("æ”¶åˆ°\n".getBytes());
	   		channel.write(outBuffer);// å°†æ¶ˆæ¯å›é€ç»™å®¢æˆ·ç«¯
	      }
  }
  }
  /**

  - åŠ å…¥ä¸€ä¸ªæ–°çš„socketå®¢æˆ·ç«¯
    */
    public void registerNewChannelTask(final SocketChannel channel){
     final Selector selector = this.selector;
     //registerTaskæ–¹æ³•æ˜¯æŠ½è±¡çš„åœ¨AbstractNioSelectorï¼Œå¾€ä¸Šé¢çœ‹
     registerTask(new Runnable() {
    	@Override
    	public void run() {
    		try {
    			//å°†å®¢æˆ·ç«¯æ³¨å†Œåˆ°selectorä¸­
    			//å°†å½“å‰çš„å®¢æˆ·ç«¯æ³¨å†Œç»™selector readäº‹ä»¶
    			channel.register(selector, SelectionKey.OP_READ);
    		} catch (ClosedChannelException e) {
    			e.printStackTrace();
    		}
    	}
    });
    }

  @Override
  protected int select(Selector selector) throws IOException {
  	return selector.select(500);
  }

}
```
ServerBootstrap.java

```js
package com.cn;
import java.net.SocketAddress;
import java.nio.channels.ServerSocketChannel;
import com.cn.pool.Boss;
import com.cn.pool.NioSelectorRunnablePool;
/**

- æœåŠ¡ç±»
- 
  *
   */
   //ç®€å•çœ‹ä¸‹å›åˆ°ä¸Šé¢çš„mainå‡½æ•°ç¬¬ä¸‰è¡Œç»‘å®šç«¯å£
  public class ServerBootstrap {
private NioSelectorRunnablePool selectorRunnablePool;
public ServerBootstrap(NioSelectorRunnablePool selectorRunnablePool) {
	this.selectorRunnablePool = selectorRunnablePool;
}

/**
 * ç»‘å®šç«¯å£
 * @param localAddress
 */
public void bind(final SocketAddress localAddress){
	try {
		// è·å¾—ä¸€ä¸ªServerSocketé€šé“
		ServerSocketChannel serverChannel = ServerSocketChannel.open();
		// è®¾ç½®é€šé“ä¸ºéé˜»å¡
		serverChannel.configureBlocking(false);
		// å°†è¯¥é€šé“å¯¹åº”çš„ServerSocketç»‘å®šåˆ°portç«¯å£
		serverChannel.socket().bind(localAddress);
		//è·å–ä¸€ä¸ªbossçº¿ç¨‹ï¼Œå› ä¸ºbossçº¿ç¨‹æ˜¯ä¸“é—¨è´Ÿè´£ç›‘å¬ç«¯å£çš„
		Boss nextBoss = selectorRunnablePool.nextBoss();
		//å‘bossæ³¨å†Œä¸€ä¸ªServerSocketé€šé“
		//æ³¨å†Œæ—¶é—´å’Œä¸Šé¢çš„workerçš„æ³¨å†Œæ—¶é—´ç±»ä¼¼
		//å…·ä½“çœ‹NioServerBoss.java
		nextBoss.registerAcceptChannelTask(serverChannel);
	} catch (Exception e) {
		e.printStackTrace();
	}
}
}
```
boss.java

```js
package com.cn.pool;

import java.nio.channels.ServerSocketChannel;
/**

- bossæ¥å£

- 
  *
   */
  public interface Boss {

  /**

  - åŠ å…¥ä¸€ä¸ªæ–°çš„ServerSocket
  - @param serverChannel
    */
    public void registerAcceptChannelTask(ServerSocketChannel serverChannel);
    }
```
worker.java

```js
package com.cn.pool;

import java.nio.channels.SocketChannel;
/**

- workeræ¥å£

-
  *
   */
  public interface Worker {

  /**

  - åŠ å…¥ä¸€ä¸ªæ–°çš„å®¢æˆ·ç«¯ä¼šè¯
  - @param channel
    */
    public void registerNewChannelTask(SocketChannel channel);

}
```

# å­¦åˆ°çš„æ€æƒ³
ä¸Šé¢çš„processæ–¹æ³•è¢«bosså’Œworkerç»§æ‰¿ï¼Œbossä¸­é™¤äº†ç»™æ–°å®¢æˆ·ç«¯acceptä¹‹å¤–ï¼Œè¿˜å¾€workerçš„é˜Ÿåˆ—ä¸­åŠ å…¥äº†å½“å‰å®¢æˆ·ç«¯çš„readä»»åŠ¡
å¾ˆå¤šæ—¶å€™éƒ½æ˜¯è¿™æ ·ï¼Œæˆ‘ä¸ä¼šå»æ“ä½œä½ çš„æŸäº›ä¸œè¥¿ï¼Œè€Œæ˜¯æŠŠä»»åŠ¡æ”¾åˆ°çš„é˜Ÿåˆ—ä¸­ï¼Œå…·ä½“æ€ä¹ˆæ‰§è¡Œå’Œæˆ‘æ— å…³ï¼Œèƒ½å¤Ÿæœ‰æ•ˆçš„è§£å†³é«˜å¹¶å‘