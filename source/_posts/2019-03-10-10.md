
title: åŸºäºNettyçš„RPCæ¶æ„å­¦ä¹ ç¬”è®°ï¼ˆåï¼‰ï¼šè‡ªå®šä¹‰æ•°æ®åŒ…åè®®
author: Leesin.Dong
top: 
tags:
  - Netty
categories:
  - å­¦ä¹ ç¬”è®°
  - åŸºäºNettyçš„RPCæ¶æ„å­¦ä¹ ç¬”è®°
date: 2019-3-10 10:21:10

---

# æ•°æ®åŒ…ç®€ä»‹
## ç²˜åŒ…ã€åˆ†åŒ…ç°è±¡
å‡å¦‚å®¢æˆ·ç«¯éœ€è¦ç»™æœåŠ¡ç«¯å‘é€æ•°æ®
give me a coffee   give me a tea
å¯èƒ½ä¼šå‡ºç°ç²˜åŒ…æˆ–è€…åˆ†åŒ…çš„ç°è±¡
- ç²˜åŒ…ç°è±¡
give me a coffeegive me a tea   
-  åˆ†åŒ…ç°è±¡
give me  
 a coffeegive me a tea    

 ç²˜åŒ…å’Œåˆ†åŒ…å‡ºç°çš„åŸå› æ˜¯ï¼šæ²¡æœ‰ä¸€ä¸ªç¨³å®šæ•°æ®ç»“æ„ï¼Œè§£å†³æ–¹æ³•æ¯”å¦‚
- åˆ†å‰²ç¬¦
give me a coffee|give me a tea|
give me a coffee|
give me a tea|
 - é•¿åº¦ + æ•°æ®
16give me a coffee13give me a tea
16give me a coffee
13give me a tea
##   æ•°æ®åŒ…æ ¼å¼
+â€”â€”----â€”â€”+â€”â€”-----â€”â€”+â€”â€”----â€”â€”+â€”â€”----â€”â€”+â€”â€”-----â€”â€”+
 | åŒ…å¤´			  | æ¨¡å—å·  | å‘½ä»¤å· |  é•¿åº¦  |   æ•°æ®  |
 +â€”â€”----â€”â€”+â€”â€”-----â€”â€”+â€”â€”----â€”â€”+â€”â€”----â€”â€”+â€”â€”-----â€”â€”+
åŒ…å¤´4å­—èŠ‚ ï¼ˆä¸€äº›ä¸å¸¸ç”¨çš„ä¸œè¥¿ï¼‰
 æ¨¡å—å·2å­—èŠ‚shortï¼ˆPlayer 1å·ï¼‰
 å‘½ä»¤å·2å­—èŠ‚shortï¼ˆPlayerè¦åšçš„äº‹æƒ…ï¼Œæ¯”å¦‚è·å–ç©å®¶æ•°æ® 1å·ï¼‰
é•¿åº¦4å­—èŠ‚(æè¿°æ•°æ®éƒ¨åˆ†å­—èŠ‚é•¿åº¦)
 Player   1
 1 è·å–ç©å®¶æ•°æ®   
 2 æ³¨å†Œç”¨æˆ·
 3 è´­ä¹°é‡‘å¸

# ä¸¾ä¸ªğŸŒ°
éœ€è¦çš„jarï¼šnetty-3.10.5.final.jar
## Commoné¡¹ç›®
æ–°å»ºé¡¹ç›®Common==ã€‹æ–°å»ºåŒ…modelã€ moduleã€codcã€constantã€serial==>modelåŒ…ä¸‹æ–°å»ºRequest.java

### Request.java
```js
package com.cn.model;
/**
 * è¯·æ±‚å¯¹è±¡
 * 
 */
public class Request {
	
	/**
	 * è¯·æ±‚æ¨¡å—
	 */
	private short module;
	
	/**
	 * å‘½ä»¤å·
	 */
	private short cmd;
	
	/**
	 * æ•°æ®éƒ¨åˆ†
	 */
	private byte[] data;

	public short getModule() {
		return module;
	}

	public void setModule(short module) {
		this.module = module;
	}

	public short getCmd() {
		return cmd;
	}

	public void setCmd(short cmd) {
		this.cmd = cmd;
	}

	public byte[] getData() {
		return data;
	}

	public void setData(byte[] data) {
		this.data = data;
	}
	
	
	public int getDataLength(){
		if(data == null){
			return 0;
		}
		return data.length;
	}
}

```
constantåŒ…ä¸‹æ–°å»º

### ConstantValue.java

```js
package com.cn.constant;

public interface ConstantValue {
	
	/**
	 * åŒ…å¤´,åŒ…å¤´æ˜¯ä¸€ä¸ªå¸¸é‡
	 */
	public static final int FLAG = -32523523;

}
```
codcåŒ…ä¸‹æ–°å»ºRequestDecoder.javaå’ŒRequestEncoder.java
### RequestEncoder.java

```js
package com.cn.codc;

import org.jboss.netty.buffer.ChannelBuffer;
import org.jboss.netty.buffer.ChannelBuffers;
import org.jboss.netty.channel.Channel;
import org.jboss.netty.channel.ChannelHandlerContext;
import org.jboss.netty.handler.codec.oneone.OneToOneEncoder;

import com.cn.constant.ConstantValue;
import com.cn.model.Request;

/**
 * è¯·æ±‚ç¼–ç å™¨
 * <pre>
 * æ•°æ®åŒ…æ ¼å¼
 * +â€”â€”----â€”â€”+â€”â€”-----â€”â€”+â€”â€”----â€”â€”+â€”â€”----â€”â€”+â€”â€”-----â€”â€”+
 * | åŒ…å¤´          | æ¨¡å—å·        | å‘½ä»¤å·      |  é•¿åº¦        |   æ•°æ®       |
 * +â€”â€”----â€”â€”+â€”â€”-----â€”â€”+â€”â€”----â€”â€”+â€”â€”----â€”â€”+â€”â€”-----â€”â€”+
 * </pre>
 * åŒ…å¤´4å­—èŠ‚
 * æ¨¡å—å·2å­—èŠ‚short
 * å‘½ä»¤å·2å­—èŠ‚short
 * é•¿åº¦4å­—èŠ‚(æè¿°æ•°æ®éƒ¨åˆ†å­—èŠ‚é•¿åº¦)
 * 
 *
 *
 */
public class RequestEncoder extends OneToOneEncoder{

	@Override
	protected Object encode(ChannelHandlerContext context, Channel channel, Object rs) throws Exception {
		Request request = (Request)(rs);
		
		ChannelBuffer buffer = ChannelBuffers.dynamicBuffer();
		//åŒ…å¤´
		buffer.writeInt(ConstantValue.FLAG);
		//module
		buffer.writeShort(request.getModule());
		//cmd
		buffer.writeShort(request.getCmd());
		//é•¿åº¦
		buffer.writeInt(request.getDataLength());
		//data
		if(request.getData() != null){
			buffer.writeBytes(request.getData());
		}
		
		return buffer;
	}

}

```

### RequestDecoder.java

```js
package com.cn.codc;

import org.jboss.netty.buffer.ChannelBuffer;
import org.jboss.netty.channel.Channel;
import org.jboss.netty.channel.ChannelHandlerContext;
import org.jboss.netty.handler.codec.frame.FrameDecoder;

import com.cn.constant.ConstantValue;
import com.cn.model.Request;

/**
 * è¯·æ±‚è§£ç å™¨
 * <pre>
 * æ•°æ®åŒ…æ ¼å¼
 * +â€”â€”----â€”â€”+â€”â€”-----â€”â€”+â€”â€”----â€”â€”+â€”â€”----â€”â€”+â€”â€”-----â€”â€”+
 * | åŒ…å¤´          | æ¨¡å—å·        | å‘½ä»¤å·      |  é•¿åº¦        |   æ•°æ®       |
 * +â€”â€”----â€”â€”+â€”â€”-----â€”â€”+â€”â€”----â€”â€”+â€”â€”----â€”â€”+â€”â€”-----â€”â€”+
 * </pre>
 * åŒ…å¤´4å­—èŠ‚
 * æ¨¡å—å·2å­—èŠ‚short
 * å‘½ä»¤å·2å­—èŠ‚short
 * é•¿åº¦4å­—èŠ‚(æè¿°æ•°æ®éƒ¨åˆ†å­—èŠ‚é•¿åº¦)
 * 
 *
 *
 */
//FrameDecoderå¯ä»¥ååŠ©æˆ‘ä»¬è§£å†³ç²˜åŒ…åˆ†åŒ…çš„é—®é¢˜
public class RequestDecoder extends FrameDecoder{
	
	/**
	 * æ•°æ®åŒ…åŸºæœ¬é•¿åº¦
	 */
	public static int BASE_LENTH = 4 + 2 + 2 + 4;

	@Override
	protected Object decode(ChannelHandlerContext arg0, Channel arg1, ChannelBuffer buffer) throws Exception {
		
		//å¯è¯»é•¿åº¦å¿…é¡»å¤§äºåŸºæœ¬é•¿åº¦
		if(buffer.readableBytes() >= BASE_LENTH){
			//é˜²æ­¢socketå­—èŠ‚æµæ”»å‡»
			if(buffer.readableBytes() > 2048){
				buffer.skipBytes(buffer.readableBytes());
			}
			
			//è®°å½•åŒ…å¤´å¼€å§‹çš„index
			int beginReader;
			
			while(true){
				beginReader = buffer.readerIndex();
				buffer.markReaderIndex();
				if(buffer.readInt() == ConstantValue.FLAG){
					break;
				}
				
				//æœªè¯»åˆ°åŒ…å¤´ï¼Œç•¥è¿‡ä¸€ä¸ªå­—èŠ‚
				buffer.resetReaderIndex();
				buffer.readByte();
				
				//é•¿åº¦åˆå˜å¾—ä¸æ»¡è¶³
				if(buffer.readableBytes() < BASE_LENTH){
					return null;
				}
			}
			
			//æ¨¡å—å·
			short module = buffer.readShort();
			//å‘½ä»¤å·
			short cmd = buffer.readShort();
			//é•¿åº¦
			int length = buffer.readInt();
			
			//åˆ¤æ–­è¯·æ±‚æ•°æ®åŒ…æ•°æ®æ˜¯å¦åˆ°é½
			if(buffer.readableBytes() < length){
				//è¿˜åŸè¯»æŒ‡é’ˆåˆ°æœ€å¼€å§‹çš„åœ°æ–¹
				buffer.readerIndex(beginReader);
				return null;
			}
			
			//è¯»å–dataæ•°æ®
			byte[] data = new byte[length];
			buffer.readBytes(data);
			
			Request request = new Request();
			request.setModule(module);
			request.setCmd(cmd);
			request.setData(data);
			
			//ç»§ç»­å¾€ä¸‹ä¼ é€’ 
			return request;
			
		}
		//æ•°æ®åŒ…ä¸å®Œæ•´ï¼Œéœ€è¦ç­‰å¾…åé¢çš„åŒ…æ¥,(buffer.readableBytes() < BASE_LENTH
		return null;
	}

}

```
ChannelBuffer writeindexå’Œreadindex
wirteindexåˆå§‹å€¼æ˜¯0ï¼Œå½“å†™ä¸€ä¸ªintï¼Œwirteindexå°±æ˜¯4
readindexåŒä¸Š
ä½†æ˜¯æ³¨æ„readindexæ˜¯ä¸èƒ½è¶…è¿‡writeindexçš„

modleåŒ…ä¸‹æ–°å»º
### Response.java

```js
package com.cn.model;
/**

- è¿”å›å¯¹è±¡

- 
  *
   */
  public class Response {
  /**

  - è¯·æ±‚æ¨¡å—
    */
    private short module;

  /**

  - å‘½ä»¤å·
    */
    private short cmd;

  /**

  - çŠ¶æ€ç 
    */
    private int stateCode;

  /**

  - æ•°æ®éƒ¨åˆ†
    */
    private byte[] data;

  public short getModule() {
  	return module;
  }

  public void setModule(short module) {
  	this.module = module;
  }

  public short getCmd() {
  	return cmd;
  }

  public void setCmd(short cmd) {
  	this.cmd = cmd;
  }

  public int getStateCode() {
  	return stateCode;
  }

  public void setStateCode(int stateCode) {
  	this.stateCode = stateCode;
  }

  public byte[] getData() {
  	return data;
  }

  public void setData(byte[] data) {
  	this.data = data;
  }

  public int getDataLength(){
  	if(data == null){
  		return 0;
  	}
  	return data.length;
  }
  }
```
modelä¸‹æ–°å»º
### StateCode.javaï¼Œresponseçš„çŠ¶æ€ç 

```js
package com.cn.model;

public interface StateCode {
	
	/**
	 * æˆåŠŸ
	 */
	public static int SUCCESS  = 0;
	
	/**
	 * å¤±è´¥
	 */
	public static int FAIL  =  1;

}

```
codcåŒ…ä¸‹æ–°å»ºResponseEncoder.javaå’ŒResponseDecoder.java
### ResponseEncoder.java

```js
package com.cn.codc;

import org.jboss.netty.buffer.ChannelBuffer;
import org.jboss.netty.buffer.ChannelBuffers;
import org.jboss.netty.channel.Channel;
import org.jboss.netty.channel.ChannelHandlerContext;
import org.jboss.netty.handler.codec.oneone.OneToOneEncoder;
import com.cn.constant.ConstantValue;
import com.cn.model.Response;

/**
 * è¯·æ±‚ç¼–ç å™¨
 * <pre>
 * æ•°æ®åŒ…æ ¼å¼
 * +â€”â€”----â€”â€”+â€”â€”-----â€”â€”+â€”â€”----â€”â€”+â€”â€”----â€”â€”+â€”â€”-----â€”â€”+â€”â€”-----â€”â€”+
 * | åŒ…å¤´          | æ¨¡å—å·        | å‘½ä»¤å·       |  çŠ¶æ€ç     |  é•¿åº¦          |   æ•°æ®       |
 * +â€”â€”----â€”â€”+â€”â€”-----â€”â€”+â€”â€”----â€”â€”+â€”â€”----â€”â€”+â€”â€”-----â€”â€”+â€”â€”-----â€”â€”+
 * </pre>
 * åŒ…å¤´4å­—èŠ‚
 * æ¨¡å—å·2å­—èŠ‚short
 * å‘½ä»¤å·2å­—èŠ‚short
 * é•¿åº¦4å­—èŠ‚(æè¿°æ•°æ®éƒ¨åˆ†å­—èŠ‚é•¿åº¦)
 * 
 * 
 */
public class ResponseEncoder extends OneToOneEncoder{

	@Override
	protected Object encode(ChannelHandlerContext context, Channel channel, Object rs) throws Exception {
		Response response = (Response)(rs);
		
		ChannelBuffer buffer = ChannelBuffers.dynamicBuffer();
		//åŒ…å¤´
		buffer.writeInt(ConstantValue.FLAG);
		//module
		buffer.writeShort(response.getModule());
		//cmd
		buffer.writeShort(response.getCmd());
		//çŠ¶æ€ç 
		buffer.writeInt(response.getStateCode());
		//é•¿åº¦
		buffer.writeInt(response.getDataLength());
		//data
		if(response.getData() != null){
			buffer.writeBytes(response.getData());
		}
		
		return buffer;
	}

}

```

### ResponseDecoder.java

```js
package com.cn.codc;

import org.jboss.netty.buffer.ChannelBuffer;
import org.jboss.netty.channel.Channel;
import org.jboss.netty.channel.ChannelHandlerContext;
import org.jboss.netty.handler.codec.frame.FrameDecoder;
import com.cn.constant.ConstantValue;
import com.cn.model.Response;

/**
 * responseè§£ç å™¨
 * <pre>
 * æ•°æ®åŒ…æ ¼å¼
 * +â€”â€”----â€”â€”+â€”â€”-----â€”â€”+â€”â€”----â€”â€”+â€”â€”----â€”â€”+â€”â€”-----â€”â€”+â€”â€”-----â€”â€”+
 * | åŒ…å¤´          | æ¨¡å—å·        | å‘½ä»¤å·       |  çŠ¶æ€ç     |  é•¿åº¦          |   æ•°æ®       |
 * +â€”â€”----â€”â€”+â€”â€”-----â€”â€”+â€”â€”----â€”â€”+â€”â€”----â€”â€”+â€”â€”-----â€”â€”+â€”â€”-----â€”â€”+
 * </pre>
 * åŒ…å¤´4å­—èŠ‚
 * æ¨¡å—å·2å­—èŠ‚short
 * å‘½ä»¤å·2å­—èŠ‚short
 * é•¿åº¦4å­—èŠ‚(æè¿°æ•°æ®éƒ¨åˆ†å­—èŠ‚é•¿åº¦)
 * 
 -
 *
 */
public class ResponseDecoder extends FrameDecoder{
	
	/**
	 * æ•°æ®åŒ…åŸºæœ¬é•¿åº¦
	 */
	public static int BASE_LENTH = 4 + 2 + 2 + 4;

	@Override
	protected Object decode(ChannelHandlerContext arg0, Channel arg1, ChannelBuffer buffer) throws Exception {
		
		//å¯è¯»é•¿åº¦å¿…é¡»å¤§äºåŸºæœ¬é•¿åº¦
		if(buffer.readableBytes() >= BASE_LENTH){
			
			//è®°å½•åŒ…å¤´å¼€å§‹çš„index
			int beginReader = buffer.readerIndex();
			
			while(true){
				if(buffer.readInt() == ConstantValue.FLAG){
					break;
				}
			}
			
			//æ¨¡å—å·
			short module = buffer.readShort();
			//å‘½ä»¤å·
			short cmd = buffer.readShort();
			//çŠ¶æ€ç 
			int stateCode = buffer.readInt();
			//é•¿åº¦
			int length = buffer.readInt();
			
			if(buffer.readableBytes() < length){
				//è¿˜åŸè¯»æŒ‡é’ˆ
				buffer.readerIndex(beginReader);
				return null;
			}
			
			byte[] data = new byte[length];
			buffer.readBytes(data);
			
			Response response = new Response();
			response.setModule(module);
			response.setCmd(cmd);
			response.setStateCode(stateCode);
			response.setData(data);
			
			//ç»§ç»­å¾€ä¸‹ä¼ é€’ 
			return response;
			
		}
		//æ•°æ®åŒ…ä¸å®Œæ•´ï¼Œéœ€è¦ç­‰å¾…åé¢çš„åŒ…æ¥
		return null;
	}

}
```
æ³¨æ„ï¼š **<font color="red">    ä¸Šé¢çš„ä»£ç åœ¨é‡åˆ°socketå­—èŠ‚æµæ”»å‡»çš„æ—¶å€™ä¼šæœ‰å¼‚å¸¸ï¼ŒåŒ…æ‹¬ä¸ºä»€ä¹ˆéœ€è¦åŒ…å¤´ï¼Œä¼šåœ¨ä¸‹é¢ä¸€èŠ‚ä¸­çš„æœ€åè¿›è¡Œè®²è§£</font>**

æ–°å»ºserialåŒ…==ã€‹å°†ä¸ŠèŠ‚æœ€åçš„ä¸¤ä¸ªåºåˆ—åŒ–çš„å·¥å…·ç±»ç²˜è´´è¿‡æ¥ï¼ˆBufferFactory.javaå’ŒSerializer.javaï¼‰
modelåŒ…ä¸‹æ–°å»ºfubenåŒ…==ã€‹æ–°å»ºå’ŒrequeståŒ…å’ŒresponseåŒ…==ã€‹requeståŒ…ä¸‹æ–°å»ºFightRequest.java==ã€‹responseåŒ…ä¸‹æ–°å»ºFightResponse.java
è¿™é‡Œçš„å‰¯æœ¬ç®€å•ç†è§£ä¸ºæ‰“æ¸¸æˆåˆ·çš„å‰¯æœ¬è¿™ä¸ªå¯¹è±¡
## FightRequest.java

```js
package com.cn.module.fuben.request;

import com.cn.serial.Serializer;

public class FightRequest extends Serializer{
	
	/**
	 * å‰¯æœ¬id
	 */
	private int fubenId;
	
	/**
	 * æ¬¡æ•°
	 */
	private int count;

	public int getFubenId() {
		return fubenId;
	}

	public void setFubenId(int fubenId) {
		this.fubenId = fubenId;
	}

	public int getCount() {
		return count;
	}

	public void setCount(int count) {
		this.count = count;
	}

	@Override
	protected void read() {
		this.fubenId = readInt();
		this.count = readInt();
	}

	@Override
	protected void write() {
		writeInt(fubenId);
		writeInt(count);
	}
	
	

}
```

## Clienté¡¹ç›®
æ–°å»ºClienté¡¹ç›®ï¼Œå°†ä¹‹å‰clientä»£ç æ‹·è´è¿‡æ¥
### Client.java

```js
package com.client;

import java.net.InetSocketAddress;
import java.util.Scanner;
import java.util.concurrent.ExecutorService;
import java.util.concurrent.Executors;
import org.jboss.netty.bootstrap.ClientBootstrap;
import org.jboss.netty.channel.Channel;
import org.jboss.netty.channel.ChannelFuture;
import org.jboss.netty.channel.ChannelPipeline;
import org.jboss.netty.channel.ChannelPipelineFactory;
import org.jboss.netty.channel.Channels;
import org.jboss.netty.channel.socket.nio.NioClientSocketChannelFactory;
import com.cn.codc.RequestEncoder;
import com.cn.codc.ResponseDecoder;
import com.cn.model.Request;
import com.cn.module.fuben.request.FightRequest;
/**
 * nettyå®¢æˆ·ç«¯å…¥é—¨
 *
 *
 */
public class Client {

	public static void main(String[] args) throws InterruptedException {
		
		//æœåŠ¡ç±»
		ClientBootstrap bootstrap = new  ClientBootstrap();
		
		//çº¿ç¨‹æ± 
		ExecutorService boss = Executors.newCachedThreadPool();
		ExecutorService worker = Executors.newCachedThreadPool();
		
		//socketå·¥å‚
		bootstrap.setFactory(new NioClientSocketChannelFactory(boss, worker));
		
		//ç®¡é“å·¥å‚
		bootstrap.setPipelineFactory(new ChannelPipelineFactory() {
			
			@Override
			public ChannelPipeline getPipeline() throws Exception {
				ChannelPipeline pipeline = Channels.pipeline();
				//ä¿®æ”¹ä¸ºåˆšåˆšå†™çš„ResponseEncoderå’ŒRequestEndoder
				pipeline.addLast("decoder", new ResponseDecoder());
				pipeline.addLast("encoder", new RequestEncoder());
				pipeline.addLast("hiHandler", new HiHandler());
				return pipeline;
			}
		});
		
		//è¿æ¥æœåŠ¡ç«¯
		ChannelFuture connect = bootstrap.connect(new InetSocketAddress("127.0.0.1", 10101));
		Channel channel = connect.sync().getChannel();
		
		System.out.println("client start");
		
		Scanner scanner = new Scanner(System.in);
		while(true){
			System.out.println("è¯·è¾“å…¥");
			int fubenId = Integer.parseInt(scanner.nextLine());
			int count = Integer.parseInt(scanner.nextLine());
			
			FightRequest fightRequest = new FightRequest();
			fightRequest.setFubenId(fubenId);
			fightRequest.setCount(count);
			
			Request request = new Request();
			request.setModule((short) 1);
			request.setCmd((short) 1);
			request.setData(fightRequest.getBytes());
			//å‘é€è¯·æ±‚
			channel.write(request);
		}
	}

}
```
ä¸»è¦çš„å˜åŒ–æ˜¯

```js
//ä¿®æ”¹ä¸ºåˆšåˆšå†™çš„ResponseEncoderå’ŒRequestEndoder
//responseè§£ç 
				pipeline.addLast("decoder", new ResponseDecoder());
				//requsetç¼–ç 
				pipeline.addLast("encoder", new RequestEncoder());
				pipeline.addLast("hiHandler", new HiHandler());
```
å’Œæœ€åå˜æˆå‘é€requst

### HiHandler.java

```js
package com.client;

import org.jboss.netty.channel.ChannelHandlerContext;
import org.jboss.netty.channel.ChannelStateEvent;
import org.jboss.netty.channel.ExceptionEvent;
import org.jboss.netty.channel.MessageEvent;
import org.jboss.netty.channel.SimpleChannelHandler;

import com.cn.model.Response;
import com.cn.model.StateCode;
import com.cn.module.fuben.request.FightRequest;
import com.cn.module.fuben.response.FightResponse;
/**
 * æ¶ˆæ¯æ¥å—å¤„ç†ç±»
 * 
 *
 */
public class HiHandler extends SimpleChannelHandler {

	/**
	 * æ¥æ”¶æ¶ˆæ¯
	 */
	@Override
	public void messageReceived(ChannelHandlerContext ctx, MessageEvent e) throws Exception {
	//ä¿®æ”¹ä¸ºresponseå¯¹è±¡
			Response message = (Response)e.getMessage();

			if(message.getModule() == 1){
				
				if(message.getCmd() == 1){
				//ä»serverç«¯è·å–æ•°æ®å¹¶è¾“å‡º
					FightResponse fightResponse = new FightResponse();
					fightResponse.readFromBytes(message.getData());
					
					System.out.println("gold:" + fightResponse.getGold());
					
				}else if(message.getCmd() == 2){
					
				}
				
			}else if (message.getModule() == 1){
				
				
			}
	}

	/**
	 * æ•è·å¼‚å¸¸
	 */
	@Override
	public void exceptionCaught(ChannelHandlerContext ctx, ExceptionEvent e) throws Exception {
		System.out.println("exceptionCaught");
		super.exceptionCaught(ctx, e);
	}

	/**
	 * æ–°è¿æ¥
	 */
	@Override
	public void channelConnected(ChannelHandlerContext ctx, ChannelStateEvent e) throws Exception {
		System.out.println("channelConnected");
		super.channelConnected(ctx, e);
	}

	/**
	 * å¿…é¡»æ˜¯é“¾æ¥å·²ç»å»ºç«‹ï¼Œå…³é—­é€šé“çš„æ—¶å€™æ‰ä¼šè§¦å‘
	 */
	@Override
	public void channelDisconnected(ChannelHandlerContext ctx, ChannelStateEvent e) throws Exception {
		System.out.println("channelDisconnected");
		super.channelDisconnected(ctx, e);
	}

	/**
	 * channelå…³é—­çš„æ—¶å€™è§¦å‘
	 */
	@Override
	public void channelClosed(ChannelHandlerContext ctx, ChannelStateEvent e) throws Exception {
		System.out.println("channelClosed");
		super.channelClosed(ctx, e);
	}
}
```
å°†åŸæ¥æ”¶åˆ°å’Œå›å†™çš„å¯¹è±¡è½¬åŒ–æˆresponseå¯¹è±¡

## Serveré¡¹ç›®
æ–°å»ºServeré¡¹ç›®ï¼Œå°†ä¹‹å‰serverä»£ç æ‹·è´è¿‡æ¥
### Server.java

```js
package com.server;

import java.net.InetSocketAddress;
import java.util.concurrent.ExecutorService;
import java.util.concurrent.Executors;

import org.jboss.netty.bootstrap.ServerBootstrap;
import org.jboss.netty.channel.ChannelPipeline;
import org.jboss.netty.channel.ChannelPipelineFactory;
import org.jboss.netty.channel.Channels;
import org.jboss.netty.channel.socket.nio.NioServerSocketChannelFactory;
import org.jboss.netty.handler.codec.string.StringDecoder;
import org.jboss.netty.handler.codec.string.StringEncoder;

import com.cn.codc.RequestDecoder;
import com.cn.codc.ResponseEncoder;
/**
 * nettyæœåŠ¡ç«¯å…¥é—¨
 *
 */
public class Server {

	public static void main(String[] args) {

		//æœåŠ¡ç±»
		ServerBootstrap bootstrap = new ServerBootstrap();
		
		//bossçº¿ç¨‹ç›‘å¬ç«¯å£ï¼Œworkerçº¿ç¨‹è´Ÿè´£æ•°æ®è¯»å†™
		ExecutorService boss = Executors.newCachedThreadPool();
		ExecutorService worker = Executors.newCachedThreadPool();
		
		//è®¾ç½®niosocketå·¥å‚
		bootstrap.setFactory(new NioServerSocketChannelFactory(boss, worker));
		
		//è®¾ç½®ç®¡é“çš„å·¥å‚
		bootstrap.setPipelineFactory(new ChannelPipelineFactory() {
			
			@Override
			public ChannelPipeline getPipeline() throws Exception {
	
				ChannelPipeline pipeline = Channels.pipeline();
				pipeline.addLast("decoder", new RequestDecoder());
				pipeline.addLast("encoder", new ResponseEncoder());
				pipeline.addLast("helloHandler", new HelloHandler());
				return pipeline;
			}
		});
		
		bootstrap.bind(new InetSocketAddress(10101));
		
		System.out.println("start!!!");
	
	}

}

```
ä¸»è¦å˜åŒ–

```js
			ChannelPipeline pipeline = Channels.pipeline();
			//å¯¹requestè§£ç 
				pipeline.addLast("decoder", new RequestDecoder());
				//responseç¼–ç 
				pipeline.addLast("encoder", new ResponseEncoder());
				pipeline.addLast("helloHandler", new HelloHandler());
				return pipeline;
```

### HiHandler.java

```js
package com.server;

import org.jboss.netty.channel.ChannelHandlerContext;
import org.jboss.netty.channel.ChannelStateEvent;
import org.jboss.netty.channel.ExceptionEvent;
import org.jboss.netty.channel.MessageEvent;
import org.jboss.netty.channel.SimpleChannelHandler;

import com.cn.model.Request;
import com.cn.model.Response;
import com.cn.model.StateCode;
import com.cn.module.fuben.request.FightRequest;
import com.cn.module.fuben.response.FightResponse;
/**
 * æ¶ˆæ¯æ¥å—å¤„ç†ç±»
 
 *
 */
public class HelloHandler extends SimpleChannelHandler {

	/**
	 * æ¥æ”¶æ¶ˆæ¯
	 */
	@Override
	public void messageReceived(ChannelHandlerContext ctx, MessageEvent e) throws Exception {

		Request message = (Request)e.getMessage();
		
		if(message.getModule() == 1){
			
			if(message.getCmd() == 1){
				
				FightRequest fightRequest = new FightRequest();
				fightRequest.readFromBytes(message.getData());
				//éœ€è¦æ‰“çš„å‰¯æœ¬idæ˜¯xxxæ‰“äº†xxxæ¬¡
				System.out.println("fubenId:" +fightRequest.getFubenId() + "   " + "count:" + fightRequest.getCount());
				
				//å›å†™æ•°æ®
				FightResponse fightResponse = new FightResponse();
				fightResponse.setGold(9999);
				
				Response response = new Response();
				response.setModule((short) 1);
				response.setCmd((short) 1);
				response.setStateCode(StateCode.SUCCESS);
				response.setData(fightResponse.getBytes());
				ctx.getChannel().write(response);
			}else if(message.getCmd() == 2){
				
			}
		
		}else if (message.getModule() == 1){
			
			
		}
	}

	/**
	 * æ•è·å¼‚å¸¸
	 */
	@Override
	public void exceptionCaught(ChannelHandlerContext ctx, ExceptionEvent e) throws Exception {
		System.out.println("exceptionCaught");
		super.exceptionCaught(ctx, e);
	}

	/**
	 * æ–°è¿æ¥
	 */
	@Override
	public void channelConnected(ChannelHandlerContext ctx, ChannelStateEvent e) throws Exception {
		System.out.println("channelConnected");
		super.channelConnected(ctx, e);
	}

	/**
	 * å¿…é¡»æ˜¯é“¾æ¥å·²ç»å»ºç«‹ï¼Œå…³é—­é€šé“çš„æ—¶å€™æ‰ä¼šè§¦å‘
	 */
	@Override
	public void channelDisconnected(ChannelHandlerContext ctx, ChannelStateEvent e) throws Exception {
		System.out.println("channelDisconnected");
		super.channelDisconnected(ctx, e);
	}

	/**
	 * channelå…³é—­çš„æ—¶å€™è§¦å‘
	 */
	@Override
	public void channelClosed(ChannelHandlerContext ctx, ChannelStateEvent e) throws Exception {
		System.out.println("channelClosed");
		super.channelClosed(ctx, e);
	}
}

```
å°†æ”¶åˆ°çš„æ•°æ®å¼ºè½¬ä¸ºrequset

## ç»“æœï¼š
è¿è¡Œï¼š
clientç«¯

```js
è¯·è¾“å…¥ï¼š
101
10
//è¦æ‰“101å‰¯æœ¬ï¼Œæ‰“åæ¬¡
```
serverç«¯

```js
fubenIDï¼š101 countï¼š10
```

clientç«¯

```js
gold:999
```
## å¼Šç«¯ï¼š
æ¯æ¬¡éƒ½è¦åšåˆ¤æ–­
```js
if(message.getModule() == 1){
			
			if(message.getCmd() == 1){
}
```
