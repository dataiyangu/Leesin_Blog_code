title: åŸºäºNettyçš„RPCæ¶æ„å­¦ä¹ ç¬”è®°ï¼ˆåäºŒï¼‰ï¼šå€ŸåŠ©springå®ç°ä¸šåŠ¡åˆ†ç¦»ã€èŠå¤©å®¤å°é¡¹ç›®ã€netty3å’Œ4ã€5çš„ä¸åŒã€ä¸šåŠ¡çº¿ç¨‹æ± ä»¥åŠæ¶ˆæ¯ä¸²è¡ŒåŒ–
author: Leesin.Dong
top: 
tags:

  - Netty
categories:
  - å­¦ä¹ ç¬”è®°
  - åŸºäºNettyçš„RPCæ¶æ„å­¦ä¹ ç¬”è®°
date: 2019-3-10 10:21:12

---

# å€ŸåŠ©springå®ç°ä¸šåŠ¡åˆ†ç¦»ï¼ˆğŸŒ°ï¼‰
## é—®é¢˜
ä¹‹å‰çš„æ–‡ç« ä¸­çš„handleræ¯æ¬¡éƒ½éœ€è¦åˆ¤æ–­å¦‚æœæ˜¯moudle=ï¼Ÿç„¶åå¦‚æœcmd=ï¼Ÿï¼Œæ‰è¿›è¡Œæˆ‘ä»¬çš„ä¸šåŠ¡ï¼Œè¿™é‡Œå¸Œæœ›èƒ½å¤Ÿé€šè¿‡æŸç§æ–¹æ³•å®ç°è‡ªåŠ¨æ‰§è¡Œmoudle=ï¼Ÿcmd=ï¼Ÿæ—¶å€™çš„æ–¹æ³•ï¼Œä»è€Œå®ç°ä¸šåŠ¡åˆ†ç¦»ã€‚
```js
public void messageReceived(ChannelHandlerContext ctx, MessageEvent e) throws Exception {
	//ä¿®æ”¹ä¸ºresponseå¯¹è±¡
			Response message = (Response)e.getMessage();
			if(message.getModule() == 1){
				if(message.getCmd() == 1){
					ã€‚ã€‚ã€‚
				}else if(message.getCmd() == 2){
				}
			}else if (message.getModule() == 1){			
			}
	}
}
```
ä¸‹é¢æ˜¯ä¸€ä¸ªé€šè¿‡springå®ç°ä¸šåŠ¡åˆ†ç¦»çš„ğŸŒ°
## SocketMoudle(interface)

```js
@SocketMoudle(moudle=1)
public interface UserService {
	@SocketCmd(cmd=1)
	public void login();
	@SocketCmd(cmd=2)
	public void getInfo();
	}
```
## Scanner.java

```js
@Component
public class Scanner implements BeanPostProcessor {
	@Override
	public Object postProcessBeforeInitialization(Object bean, String beanName) throws BeansException {
		return bean;
	}
	@Override
	public Object postProcessAfterInitialization(Object bean, String beanName) throws BeansException {
		Class<? extends Object> clazz = bean.getClass();
		Class<?>[] interfaces = clazz.getInterfaces();
		if(interfaces != null && interfaces.length > 0){
			//æ‰«æç±»çš„æ‰€æœ‰æ¥å£çˆ¶ç±»
			for (Class<?> interFace : interfaces) {
				//åˆ¤æ–­æ˜¯å¦ä¸ºhandleræ¥å£ç±»
				//getAnnotationè·å¾—interfaceä¸­æ³¨è§£åå­—ä¸ºSocketModuleçš„æ³¨è§£å¯¹è±¡
				SocketModule socketModule = interFace.getAnnotation(SocketModule.class);
				if (socketModule == null) {
					continue;
				}
				
				//æ‰¾å‡ºå‘½ä»¤æ–¹æ³•
				Method[] methods = interFace.getMethods();
				if(methods != null && methods.length > 0){
					for(Method method : methods){
				//getAnnotationè·å¾—methodä¸­æ³¨è§£åå­—ä¸ºSocketCmdçš„æ³¨è§£å¯¹è±¡
						SocketCmd socketCmd = method.getAnnotation(SocketCmd.class);
						if(socketCmd == null){
							continue;
						}	
						//è·å¾—æ³¨è§£é‡Œé¢çš„moudleå€¼			
						final short module = socketModule.module();
						//è·å¾—æ³¨è§£é‡Œé¢çš„cmdå€¼
						final short cmd = socketCmd.cmd();
						//InvokerHolderã€Invokeråœ¨ä¸‹é¢ï¼Œå¯¹invokeè¿›è¡Œäº†å°è£…
						if(InvokerHoler.getInvoker(module, cmd) == null){
							InvokerHoler.addInvoker(module, cmd, Invoker.valueOf(method, bean));
						}else{
							System.out.println("é‡å¤å‘½ä»¤:"+"module:"+module +" "+"cmdï¼š" + cmd);
						}
					}
				}
				
			}
		}
		return bean;
	}

}

```
Invoker.java

```js
public class Invoker {
	
	/**
	 * æ–¹æ³•
	 */
	private Method method;
	
	/**
	 * ç›®æ ‡å¯¹è±¡
	 */
	private Object target;
	
	public static Invoker valueOf(Method method, Object target){
		Invoker invoker = new Invoker();
		invoker.setMethod(method);
		invoker.setTarget(target);
		return invoker;
	}
	
	/**
	 * æ‰§è¡Œ
	 * @param paramValues
	 * @return
	 * @throws InvocationTargetException 
	 * @throws IllegalArgumentException 
	 * @throws IllegalAccessException 
	 */
	public Object invoke(Object... paramValues){
		try {
			return method.invoke(target, paramValues);
		} catch (IllegalAccessException e) {
			e.printStackTrace();
		} catch (IllegalArgumentException e) {
			e.printStackTrace();
		} catch (InvocationTargetException e) {
			e.printStackTrace();
		}
		return null;
	}

	public Method getMethod() {
		return method;
	}

	public void setMethod(Method method) {
		this.method = method;
	}

	public Object getTarget() {
		return target;
	}

	public void setTarget(Object target) {
		this.target = target;
	}
}
```
InvokerHodler.java

```js

public class InvokerHoler {
	
    /**å‘½ä»¤è°ƒç”¨å™¨*/
    private static Map<Short, Map<Short, Invoker>> invokers = new HashMap<>();
    
    /**
     * æ·»åŠ å‘½ä»¤è°ƒç”¨
     * @param module
     * @param cmd
     * @param invoker
     */
    public static void addInvoker(short module, short cmd, Invoker invoker){
    	Map<Short, Invoker> map = invokers.get(module);
    	if(map == null){
    		map = new HashMap<>();
    		invokers.put(module, map);
    	}
    	map.put(cmd, invoker);
    }
    
    
    /**
     * è·å–å‘½ä»¤è°ƒç”¨
     * @param module
     * @param cmd
     * @param invoker
     */
    public static Invoker getInvoker(short module, short cmd){
    	Map<Short, Invoker> map = invokers.get(module);
    	if(map != null){
    		return map.get(cmd);
    	}
    	return null;
    }

}

```
å°†Scanneräº¤ç»™springå¤„ç†ï¼Œè¿™æ ·ï¼Œå°±å¯ä»¥é€šè¿‡æ³¨è§£å®ç°ä¸šåŠ¡åˆ†ç¦»ã€‚
# èŠå¤©å®¤é¡¹ç›®
èŠå¤©å®¤åŠŸèƒ½ï¼šå¤šä¸ªå®¢æˆ·ç«¯èƒ½å¤Ÿåœ¨ç±»ä¼¼qqç¾¤é‡ŒèŠå¤©ï¼ŒæŸä¸ªç”¨æˆ·èƒ½å¤ŸæŒ‡å®šè§’è‰²å‡ å¯ä»¥æ”¶åˆ°æ¶ˆæ¯ï¼Œå¦‚æœè§’è‰²åœ¨å¦ä¸€ä¸ªå®¢æˆ·ç«¯è¢«ç™»å½•ï¼Œä¼šè¢«æŒ¤ä¸‹çº¿ã€‚
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](../images/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2RhdGFpeWFuZ3U=,size_16,color_FFFFFF,t_70-20190312195922562.png)

#  netty3å’Œ4ã€5çš„ä¸åŒ
|ä½œç”¨|netty3|netty4/5|
|:-----:|-|-|
|åˆ¤æ–­æ˜¯å¦è¿æ¥|channel.isConnected | channel.isActive                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
|å‘é€æ•°æ®|write|writeAndFlush                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
|ç»‘å®š|getAttachementã€setAttachementã€removeAttachement| channe.attr(ATTACHMENT_KEY).set(attachement)/get()/remove()                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
|å†™æ•°æ®ï¼ˆé‡Œé¢çš„æ–¹æ³•ä¸€æ ·ï¼Œåªæ˜¯å¯¹è±¡åå­—å˜äº†ï¼‰|ChannelBuffer|ByteBuf                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
|newä¸€ä¸ªchannel| ChannelBuffers.dynamicBuffer() |  PooledByteBufAllocatorä¸€ä¸ªå†…å­˜ç”³è¯·å™¨(è¦æ³¨æ„ä½¿ç”¨å®Œåé‡Šæ”¾buffer)releaseï¼ˆï¼‰é‡Šæ”¾æˆ–UnpooledByteBufAllocatorï¼ˆæœ€å¥½ä¹Ÿè¿›è¡Œä¸€æ¬¡é‡Šæ”¾ï¼‰æˆ–Unpooledï¼ˆåº•å±‚èµ°çš„æ˜¯UnpooledByteBufAllocatorï¼‰       æ³¨æ„ç”³è¯·ä¸€æ¬¡ï¼Œå°±åªèƒ½é‡Šæ”¾ä¸€æ¬¡       -------å½“ç„¶nettyå°è£…æ¶ˆæ¯çš„bytebufç”¨çš„æ˜¯UnpooledByteBufAllocatorï¼Œå¯ä»¥é€šè¿‡new ServerBootstrap().childOption(channelOption.ALLOCATOR,PooledByteBufAllocator.DEFAULT);è¿˜æœ‰ï¼šdecodeæ–¹æ³•ä¸­ä¼ å…¥çš„bufferæ˜¯nettyå¸®æˆ‘ä»¬åˆ›å»ºçš„ï¼Œdecodeæ–¹æ³•ä¸Šå±‚è‡ªåŠ¨åˆ¤æ–­å¦‚æœç¼“å­˜ï¼ˆcumulationï¼‰ä¸­æ²¡æœ‰äº†æ•°æ®å°±ä¼šè‡ªåŠ¨é‡Šæ”¾ã€‚ç»§æ‰¿è‡ªSimpleChannelInbundHandlerçš„handleré¡¶å±‚ä¹Ÿä¼šè‡ªåŠ¨é‡Šæ”¾                                                                                           |
|ååŠ©æˆ‘ä»¬è§£å†³ç²˜åŒ…åˆ†åŒ…çš„é—®é¢˜ï¼ˆé‡Œé¢å®ç°çš„åŸç†å·®ä¸å¤šï¼Œåªæ˜¯æ”¹äº†åå­—ï¼‰è§£ç å™¨|FrameDecoder|ByteToMessageDecoder                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| ç¼–ç å™¨|OneToOneEncoder|MessageToByteEncoder                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
|æ¥æ”¶æ¶ˆæ¯| messageReceive|channelRead0(netty5é‡Œé¢æ˜¯messageReceive)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
# ä¸šåŠ¡çº¿ç¨‹æ± 
å‰é¢è®²åˆ°æŠ½è±¡çš„ä¾‹å­ï¼Œbosså’Œworkeråˆ†åˆ«æ˜¯é¤å…çš„æœåŠ¡å‘˜ï¼Œè´Ÿè´£çš„æ˜¯å¸®å®¢äººç‚¹èœï¼Œå¯æ˜¯ç‚¹å®Œèœä¹‹ååšèœçš„è¿‡ç¨‹ä¹ˆï¼Ÿåšèœçš„è¿‡ç¨‹å°±æ˜¯ä¸šåŠ¡ï¼Œæ˜¯ä¸èƒ½äº¤ç»™æœåŠ¡å‘˜ï¼ˆbooså’Œworkeræ¥åšçš„ï¼‰ï¼Œå¦åˆ™æ•ˆç‡å¤§æ‰“æŠ˜æ‰£ã€‚å¨å¸ˆåº”è¯¥æœ‰å¤šä¸ªï¼Œaé¡¾å®¢è¦çš„æ‰å¨å¸ˆ1æ¥åšï¼Œå‰©ä¸‹è¿˜æœ‰å¤šä¸ªå¨å¸ˆï¼Œä¸å½±å“å…¶ä»–é¡¾å®¢çš„æ­£å¸¸æ¶ˆè´¹ã€‚
ä¸Šé¢ä¾‹å­ä¸­æ•´ä¸ªå¨å¸ˆå›¢é˜Ÿå°±æ˜¯ä¸šåŠ¡çº¿ç¨‹æ± ã€‚

æ³¨æ„ï¼šå¦‚æœä¸ä½œå¤„ç†çš„è¯ï¼Œä¸šåŠ¡æ˜¯åœ¨workerçº¿ç¨‹ä¸­çš„
## netty3ä¸­è§£å†³æ–¹æ³•

```js
public class HiHandler extends SimpleChannelHandler {
	public static ExecutorService executorService = Executors.newFixedTHeradPool(Runtime.getRuntime().availableProcessors()*2);
	/**
	 * æ¥æ”¶æ¶ˆæ¯
	 */
	@Override
	public void messageReceived(ChannelHandlerContext ctx, MessageEvent e) throws Exception {
	//ä¿®æ”¹ä¸ºresponseå¯¹è±¡
			Response message = (Response)e.getMessage();
			RUnnavle task  = handlerMessage(new SessionImpl(ctx.getChannel()),request);
			executorService.execute(task);
	}
	/**
	 * æ¶ˆæ¯å¤„ç†
	 */
	public Runnavle handlerMessage(final Session session,final Request request){
		return new Runnable(){
			//æ­¤å¤„çœç•¥ä¸šåŠ¡å¤„ç†çš„è¿‡ç¨‹ï¼Œè‡ªè¡Œè„‘è¡¥
			...
		}
	}
}
```
æ³¨æ„ï¼š
å¦‚æœä¸è‡ªå·±å°†ä¸šåŠ¡è¿›è¡Œå¼‚æ­¥çš„è¯ï¼Œnettyå…¶å®æ˜¯ä¸€ä¸ªåŒæ­¥çš„è¿‡ç¨‹ï¼ˆè™½ç„¶nettyè¢«å«åšå¼‚æ­¥ï¼‰ã€‚
ä¸šåŠ¡ä¸­å›å†™æ•°æ®ä¹Ÿé»˜è®¤æ˜¯å¼‚æ­¥çš„ï¼Œå› ä¸ºåœ¨å‰é¢çš„æºç ä»‹ç»ä¸­æœ‰ä»‹ç»ï¼ŒAbstractNioSelector.javaä¸­çš„runæ–¹æ³•é‡Œé¢æœ‰ processTaskQueue();å°±æ˜¯è®²writeå›å†™çš„æ•°æ®å°è£…åˆ°äº†é˜Ÿåˆ—ä¸­ï¼Œä¾›å¼‚æ­¥è°ƒç”¨ã€‚



## netty4ã€netty5ä¸­çš„è§£å†³æ–¹æ³•
ä¸éœ€è¦è‡ªå·±newä¸€ä¸ªçº¿ç¨‹æ± 
Server.java(serverä¸­)
```js
public class Server {

	public static void main(String[] args) throws InterruptedException {
		//æœåŠ¡ç±»
		ClientBootstrap bootstrap = new  ClientBootstrap();
		//çº¿ç¨‹æ± 
		EventLoopGroup bossGroup = new.NioEventLoopGroup();
		EventLoopGroup workerGroup = new.NioEventLoopGroup();
		//ä¸šåŠ¡çº¿ç¨‹æ± 
		EventLoopGroup busyGroup = new.NioEventLoopGroup();

		...
		ch.pipeline().addLast(new ResponseDecoder());
		ch.pipeline.addLast(new RequestEncoder());
		ch.pipeline.addLast(busyGroup,new HiHandler());
		...
```
è¿™é‡Œåªéœ€è¦

```js
EventLoopGroup busyGroup = new.NioEventLoopGroup();
ch.pipeline.addLast(busyGroup,new HiHandler());//åœ¨new HiHandlerï¼ˆï¼‰å‰é¢åŠ å…¥busyGroupå‚æ•°
```
åŸæœ¬çš„handlerå°±ä¸æ˜¯å†workerä¸­è¿è¡Œäº†ï¼Œå˜æˆäº†åœ¨ä¸Šé¢çš„çº¿ç¨‹æ± å¾ªç¯ç»„ä¸­è¿è¡Œ

å¦‚æœä¸åŠ å…¥è¿™ä¸ªå‚æ•°ï¼ŒHiHandlerå’ŒRequestEncoderæ˜¯åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­çš„ï¼ˆworkerï¼‰
åŠ å…¥ä¹‹åä¸¤ä¸ªhandlerå°±ä¸åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­äº†ã€‚

 **<font color="red">æ³¨æ„ï¼š netty4ã€netty5ä¸­çš„è¿™ç§æ–¹æ³•æ¯”netty3è¦å¥½   </font>**
 å› ä¸ºåœ¨EventLoopGroupå…·æœ‰æ¶ˆæ¯ä¸²è¡ŒåŒ–çš„åŠŸèƒ½

## ä»€ä¹ˆæ˜¯æ¶ˆæ¯ä¸²è¡ŒåŒ–ï¼Ÿ
ä¸¾ä¸ªğŸŒ°ï¼š
å‡å¦‚aå’ŒbåŒæ—¶åœ¨æ‰“æ¸¸æˆ
aå‘å‡ºæŒ‡ä»¤1-1ï¼Œè¦æ±‚é”å®šè‡ªå·±çš„è´¦å·ï¼Œbä¹Ÿå‘å‡ºæŒ‡ä»¤2-1ï¼Œè¦æ±‚é”å®šaçš„è´¦å·ï¼Œä¸¤è€…ä¹‹é—´å­˜åœ¨é”ç«äº‰æ˜¯æ­£å¸¸çš„ã€‚
å¯æ˜¯å¦‚æœaè‡ªå·±å‘å‡ºäº†5æ¡1-1çš„æŒ‡ä»¤ï¼Œå³è¿ç»­è¦æ±‚é”å®šè‡ªå·±äº”æ¬¡ï¼Œäº”æ¬¡è¯·æ±‚åŒæ—¶è¿›è¡Œï¼Œå°±ä¼šè‡ªå·±è·Ÿè‡ªå·±ç«äº‰ã€‚
ä¸€æ—¦æœ‰äº†é”çš„ç«äº‰ï¼Œå°±ä¼šååˆ†å½±å“æ•ˆç‡

æ¶ˆæ¯ä¸²è¡ŒåŒ–å°±æ˜¯è¯·æ±‚ä¸€ä¸ªä¸€ä¸ªæ‰§è¡Œ

æ‰€ä»¥åœ¨netty3ä¸­éœ€è¦è‡ªå·±å®ç°ç¼–å†™å¯ä»¥å®ç°æœ‰åºçš„è¯·æ±‚çš„å¤„ç†çº¿ç¨‹ï¼Œä½†æ˜¯åœ¨netty4ï¼Œnetty5ä¸­EventLoopGroupå…·æœ‰æ¶ˆæ¯ä¸²è¡ŒåŒ–çš„åŠŸèƒ½ã€‚

å…·ä½“å®ç°å¯ä»¥å¼€å¯å¤šä¸ªçº¿ç¨‹ï¼Œçº¿ç¨‹ä¸­å­˜å‚¨ç€é˜Ÿåˆ—ï¼Œå°†aå’Œbçš„è¯·æ±‚åˆ†åˆ«æ”¾åˆ°è‡ªå·±å¯¹åº”çš„çº¿ç¨‹ä¸­çš„é˜Ÿåˆ—ä¸­å»ï¼Œé€šè¿‡é˜Ÿåˆ—å»æ‰§è¡Œï¼Œè¾¾åˆ°æ¶ˆæ¯çš„ä¸²è¡ŒåŒ–ã€‚