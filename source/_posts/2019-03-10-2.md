title: åŸºäºNettyçš„RPCæ¶æ„å­¦ä¹ ç¬”è®°ï¼ˆäºŒï¼‰ï¼šnettyæœåŠ¡å™¨
author: Leesin.Dong
top: 
tags:
  - Netty
categories:
  - å­¦ä¹ ç¬”è®°
  - åŸºäºNettyçš„RPCæ¶æ„å­¦ä¹ ç¬”è®°
date: 2019-3-10 10:21:02

---

# ç®€ä»‹
nettyç‰ˆæœ¬å¤§è‡´ç‰ˆæœ¬åˆ†ä¸º  netty3.x  å’Œ  netty4.xã€netty5.x

nettyå¯ä»¥è¿ç”¨åœ¨é‚£äº›é¢†åŸŸï¼Ÿ

1. åˆ†å¸ƒå¼è¿›ç¨‹é€šä¿¡
ä¾‹å¦‚: hadoopã€dubboã€akkaç­‰å…·æœ‰åˆ†å¸ƒå¼åŠŸèƒ½çš„æ¡†æ¶ï¼Œåº•å±‚RPCé€šä¿¡éƒ½æ˜¯åŸºäºnettyå®ç°çš„ï¼Œè¿™äº›æ¡†æ¶ä½¿ç”¨çš„ç‰ˆæœ¬é€šå¸¸éƒ½è¿˜åœ¨ç”¨netty3.x

2. æ¸¸æˆæœåŠ¡å™¨å¼€å‘
æœ€æ–°çš„æ¸¸æˆæœåŠ¡å™¨æœ‰éƒ¨åˆ†å…¬å¸å¯èƒ½å·²ç»å¼€å§‹é‡‡ç”¨netty4.x æˆ– netty5.x

# NettyæœåŠ¡ç«¯Hello Worldæ¡ˆä¾‹
## ä¸¾ä¸ªğŸŒ°
server.java
```js
package com.server;

import java.net.InetSocketAddress;
import java.util.concurrent.ExecutorService;
import java.util.concurrent.Executors;

import org.jboss.netty.bootstrap.ServerBootstrap;
import org.jboss.netty.channel.ChannelPipeline;
import org.jboss.netty.channel.ChannelPipelineFactory;
import org.jboss.netty.channel.Channels;
import org.jboss.netty.channel.socket.nio.NioServerSocketChannelFactory;
import org.jboss.netty.handler.codec.string.StringDecoder;
import org.jboss.netty.handler.codec.string.StringEncoder;
/**

- nettyæœåŠ¡ç«¯å…¥é—¨

-
  *
   */
  public class Server {

  public static void main(String[] args) {


  //æœåŠ¡ç±»
  ServerBootstrap bootstrap = new ServerBootstrap();
  
  //bossçº¿ç¨‹ç›‘å¬ç«¯å£ï¼Œworkerçº¿ç¨‹è´Ÿè´£æ•°æ®è¯»å†™
  ExecutorService boss = Executors.newCachedThreadPool();
  ExecutorService worker = Executors.newCachedThreadPool();
  
  //è®¾ç½®niosocketå·¥å‚
  bootstrap.setFactory(new NioServerSocketChannelFactory(boss, worker));
  
  //è®¾ç½®ç®¡é“çš„å·¥å‚ï¼Œç®¡é“æ˜¯æœåŠ¡ï¼Œç›¸å½“äºè£…äº†ä¸€å¤§å †çš„è¿‡æ»¤å™¨
  bootstrap.setPipelineFactory(new ChannelPipelineFactory() {
  	
  	@Override
  	public ChannelPipeline getPipeline() throws Exception {
  
  		ChannelPipeline pipeline = Channels.pipeline();
  		pipeline.addLast("decoder", new StringDecoder());
  		pipeline.addLast("encoder", new StringEncoder());
  		//æ¥æ”¶æ¶ˆæ¯
  		pipeline.addLast("helloHandler", new HelloHandler());
  		return pipeline;
  	}
  });
  //ç»‘å®šç«¯å£
  bootstrap.bind(new InetSocketAddress(10101));
  
  System.out.println("start!!!");
  

  }

}
```
HelloHandler.java
```js
package com.server;

import org.jboss.netty.channel.ChannelHandlerContext;
import org.jboss.netty.channel.ChannelStateEvent;
import org.jboss.netty.channel.ExceptionEvent;
import org.jboss.netty.channel.MessageEvent;
import org.jboss.netty.channel.SimpleChannelHandler;
/**

- æ¶ˆæ¯æ¥å—å¤„ç†ç±»

-
  *
   */
  public class HelloHandler extends SimpleChannelHandler {

  /**

  - æ¥æ”¶æ¶ˆæ¯
    */
    @Override
    public void messageReceived(ChannelHandlerContext ctx, MessageEvent e) throws Exception {

    String s = (String) e.getMessage();
    System.out.println(s);

    //å›å†™æ•°æ®
    ctx.getChannel().write("hi");
    super.messageReceived(ctx, e);
    }

  /**

  - æ•è·å¼‚å¸¸
    */
    @Override
    public void exceptionCaught(ChannelHandlerContext ctx, ExceptionEvent e) throws Exception {
    System.out.println("exceptionCaught");
    super.exceptionCaught(ctx, e);
    }

  /**

  - æ–°è¿æ¥
    */
    @Override
    public void channelConnected(ChannelHandlerContext ctx, ChannelStateEvent e) throws Exception {
    System.out.println("channelConnected");
    super.channelConnected(ctx, e);
    }

  /**

  - å¿…é¡»æ˜¯é“¾æ¥å·²ç»å»ºç«‹ï¼Œå…³é—­é€šé“çš„æ—¶å€™æ‰ä¼šè§¦å‘
    */
    @Override
    public void channelDisconnected(ChannelHandlerContext ctx, ChannelStateEvent e) throws Exception {
    System.out.println("channelDisconnected");
    super.channelDisconnected(ctx, e);
    }

  /**

  - channelå…³é—­çš„æ—¶å€™è§¦å‘
    */
    @Override
    public void channelClosed(ChannelHandlerContext ctx, ChannelStateEvent e) throws Exception {
    System.out.println("channelClosed");
    super.channelClosed(ctx, e);
    }
    }
```
å¯åŠ¨Server.java
è¾“å‡º
```js
start!!!
```
telnet
è¾“å…¥
```js
telnet 127.0.0.1 10101
```
å›è½¦
è¾“å‡º
```js
channelConnected
```
telnet
è¾“å…¥
```js
send hello
```
å›è½¦
è¾“å‡º
```js
messageReceived
```
åœ¨messageReceivedæ–¹æ³•å¤„åŠ int i = i/10
è¾“å‡º
```js
messageReceived
exception
```
å…³é—­telnet
è¾“å‡º

```js
channelDisconnected
channelClosed
```
channelDisconnectedå’ŒchannelClosedçš„åŒºåˆ«
channelDisconnectedï¼šå¿…é¡»æ˜¯é“¾æ¥å·²ç»å»ºç«‹ï¼Œå…³é—­é€šé“çš„æ—¶å€™æ‰ä¼šè§¦å‘
channelClosedï¼šchannelå…³é—­çš„æ—¶å€™è§¦å‘
å®¢æˆ·ç«¯è¿æ¥ä¸æˆåŠŸçš„è¯ä¸ä¼šè§¦å‘channelDisconnectedï¼Œåªä¼šè§¦å‘channelClosedæ–¹æ³•

## å°æ”¹è¿›
- æ¥æ”¶æ•°æ®æ”¹è¿›
æ³¨æ„messageReceivedæ–¹æ³•ä¸­æœ¬åº”è¯¥æ˜¯

```js
ChannelBuffer message = (ChannelBuffer)e.getMessage();
String s = new String(message.array());
```
å®é™…ä¸Šåº”è¯¥æ˜¯Nettyè¿›è¡Œäº†å°è£…
Server.javaä¸­åŠ å…¥
```js
pipeline.addLast("decoder", new StringDecoder());
```
messageReceivedä¸­å°±å¯ä»¥æ”¹æˆ

```js
String s = e.getMessage();
```
è¿™æ ·å’Œä¸Šé¢æ˜¯ä¸€æ ·çš„æ•ˆæœ


- å›å†™æ•°æ®
messageReceivedæ–¹æ³•ä¸­
```js
ctx.getChannel().write("hi");
```
è¿™æ ·æ˜¯ä¼šæŠ¥é”™çš„ï¼Œåº”è¯¥ä¼ ä¸€ä¸ªChannelBuffer

```js
ChannelBuffer copoedBuffer = ChannelBuffers.copiedBuffer("hi".getBytes());
ctx.getChannel.write(copoedBuffer);
```
å¯æ˜¯è¿™æ ·è¿˜æ˜¯æŒºéº»çƒ¦çš„Nettyè¿˜æ˜¯å¸®æˆ‘ä»¬å°è£…å¥½äº†
åœ¨Server.javaä¸­

```js
pipeline.addLast("encoder", new StringEncoder());
```
ä¼šå†™æ•°æ®å°±å¯çŸ¥ç›´æ¥

```js
ctx.getChannel().write("hi");
```
## é‡ç‚¹è®²è§£

```js
 	@Override
  	public ChannelPipeline getPipeline() throws Exception {
  
  		ChannelPipeline pipeline = Channels.pipeline();
  		pipeline.addLast("decoder", new StringDecoder());
  		pipeline.addLast("encoder", new StringEncoder());
  		//æ¥æ”¶æ¶ˆæ¯
  		pipeline.addLast("helloHandler", new HelloHandler());
  		return pipeline;
  	}
```
ç®¡é“åˆ†ä¸ºæ¶ˆæ¯åˆ†ä¸ºäº†ä¸Šè¡Œå’Œä¸‹è¡Œ
StringDecoderç»§æ‰¿ChannelIpstreamHandler
StringEncoderç»§æ‰¿äº†ChannelDownStreamHandler
HelloHandlerç»§æ‰¿äº†SimpleChannelHandler
ä¸Šè¡Œä¼šç»è¿‡HelloHandlerï¼Œç„¶åä¸‹è¡Œå›å†™æ•°æ®å°±ä¼šç»è¿‡StringEncoderï¼Œç„¶åå†å›å†™æ•°æ®ç»™å®¢æˆ·ç«¯
# æ€»ç»“

## nettyæœåŠ¡ç«¯hello worldæ¡ˆä¾‹

```js

SimpleChannelHandler å¤„ç†æ¶ˆæ¯æ¥æ”¶å’Œå†™
{
	messageReceivedæ¥æ”¶æ¶ˆæ¯

	channelConnectedæ–°è¿æ¥ï¼Œé€šå¸¸ç”¨æ¥æ£€æµ‹IPæ˜¯å¦æ˜¯é»‘åå•ï¼Œæ¯æ¬¡åšä¸€ä¸ªç»Ÿè®¡ï¼Œ
	å½“ç¨‹åºå‘˜æ¶æ„é€šè¿‡å®¢æˆ·ç«¯ä¸æ–­åœ°å‘é€è¯·æ±‚ï¼Œ
	ç»è¿‡è¯†åˆ«ï¼Œå°±ä¼šchannel.closeå…³é—­æ‰ï¼Œé€šè¿‡å¤„ç†åŠ å…¥é»‘åå•ã€‚

	channelDisconnectedé“¾æ¥å…³é—­ï¼Œå¯ä»¥å†ç”¨æˆ·æ–­çº¿çš„æ—¶å€™æ¸…æ¥šç”¨æˆ·çš„ç¼“å­˜æ•°æ®ç­‰
}

```
bosså’Œworkerçº¿ç¨‹æ± é‡Œé¢å…¶å®æ˜¯ä¸€ä¸ªçº¿ç¨‹ï¼Œé‡Œé¢æ˜¯selectorï¼Œboss selectoræ˜¯ç”¨æ¥ç›‘å¬ç«¯å£çš„ï¼Œworker selectoræ˜¯è´Ÿè´£channelçš„è¯»å†™ä»»åŠ¡çš„


## channelDisconnectedä¸channelClosedçš„åŒºåˆ«ï¼Ÿ

channelDisconnectedåªæœ‰åœ¨è¿æ¥å»ºç«‹åæ–­å¼€æ‰ä¼šè°ƒç”¨
channelClosedæ— è®ºè¿æ¥æ˜¯å¦æˆåŠŸéƒ½ä¼šè°ƒç”¨å…³é—­èµ„æº
